================================================================================
INTEGRATED LENS SYSTEM (ILS) - COMPREHENSIVE SAAS DOCUMENTATION
PART 3: WORKFLOWS, USER JOURNEYS & IMPLEMENTATION GUIDE
================================================================================
Generated: November 2, 2025
Repository: ILS2.0 (newvantageco)
Version: 1.0.0

================================================================================
TABLE OF CONTENTS - PART 3
================================================================================
1. User Workflows & Journeys
2. Implementation & Setup Guide
3. Development Workflow
4. Testing Strategy
5. Deployment Process
6. Common Use Cases
7. Troubleshooting Guide

================================================================================
1. USER WORKFLOWS & JOURNEYS
================================================================================

1.1 ECP (EYE CARE PROFESSIONAL) WORKFLOWS
------------------------------------------

WORKFLOW 1: PATIENT REGISTRATION & ORDER CREATION
--------------------------------------------------
Scenario: ECP examines a patient and needs to order prescription lenses

Step-by-Step:
1. Login to system with ECP credentials
2. Navigate to Patients page (/ecp/patients)
3. Click "Add Patient" button
4. Fill patient information form:
   - First Name, Last Name
   - Date of Birth
   - Contact information (email, phone)
   - Address (optional)
5. Submit form
6. System auto-generates customer number (CUST-XXXXXX)
7. Patient appears in patient list

8. Navigate to New Order page (/ecp/new-order)
9. Multi-step order wizard opens:

   STEP 1 - Patient Information:
   - Select patient from dropdown (search by name or customer number)
   - Or click "Add New Patient" if not registered
   - Add customer reference (optional)
   
   STEP 2 - Prescription Entry:
   - Enter Right Eye (OD) values:
     * Sphere, Cylinder, Axis, Add, PD
   - Enter Left Eye (OS) values:
     * Sphere, Cylinder, Axis, Add, PD
   - OR Upload OMA file (drag-and-drop or click to browse)
   - If OMA uploaded, system auto-fills prescription data
   - Preview OMA tracing visualization
   
   STEP 3 - Lens & Frame Specifications:
   - Select lens type (single vision, bifocal, progressive)
   - Select lens material (standard, polycarbonate, high-index)
   - Select coating (anti-reflective, blue light, photochromic)
   - Select frame type (full rim, semi-rimless, rimless)
   - Enter frame measurements if available
   
   STEP 4 - Review & Submit:
   - Review all entered information
   - Add special notes or instructions
   - Click "Submit Order"

10. System creates order with status "pending"
11. Confirmation message displays with order ID
12. Order appears in ECP dashboard

Expected Time: 5-10 minutes per order
System Response: Instant confirmation

WORKFLOW 2: ORDER TRACKING & STATUS MONITORING
-----------------------------------------------
Scenario: ECP wants to check status of submitted orders

Step-by-Step:
1. Login and navigate to ECP Dashboard (/ecp/dashboard)
2. View orders table with columns:
   - Order ID
   - Patient Name
   - Customer Reference
   - Status (with color-coded badge)
   - Date Created
   - Actions
3. Filter orders by status:
   - Pending, In Production, Quality Check, Shipped, Completed
4. Click on order row to view details
5. Order Details page shows:
   - Full prescription information
   - OMA tracing visualization (if uploaded)
   - Current status with timeline
   - All status changes with timestamps and user who made change
   - Estimated completion date
6. Receive real-time updates via WebSocket when status changes

Status Indicators:
- ðŸŸ¡ Pending: Order received, awaiting production
- ðŸ”µ In Production: Being manufactured
- ðŸŸ£ Quality Check: Undergoing inspection
- ðŸŸ  Shipped: On the way to ECP
- ðŸŸ¢ Completed: Delivered and confirmed
- ðŸ”´ On Hold: Temporarily paused
- âš« Cancelled: Order cancelled

Expected Time: 1-2 minutes to check status
Real-time Updates: Yes (WebSocket)

WORKFLOW 3: POINT OF SALE TRANSACTION
--------------------------------------
Scenario: Customer walks in to purchase frames or contact lenses

Step-by-Step:
1. Navigate to POS page (/ecp/pos)
2. Search or browse product inventory
3. Add items to cart:
   - Select product
   - Enter quantity
   - Product details and price display
4. Review cart with line items
5. Apply discount if applicable
6. Calculate tax
7. Select payment method:
   - Cash
   - Card
   - Mixed (partial cash, partial card)
8. Enter payment details
9. Generate invoice
10. Print receipt or email to customer
11. System updates inventory stock levels
12. Invoice saved with status "paid"

Product Types Available:
- Frames (eyeglass frames)
- Contact lenses (boxes)
- Solutions (cleaning, storage)
- Services (adjustments, repairs)

Expected Time: 3-5 minutes per transaction
Inventory Update: Automatic

WORKFLOW 4: EYE EXAMINATION & PRESCRIPTION RECORDING
-----------------------------------------------------
Scenario: Optometrist conducts eye exam and records results

Step-by-Step:
1. Navigate to Test Rooms page (/ecp/test-rooms)
2. Check room availability
3. Book test room for patient:
   - Select patient
   - Select room
   - Set start and end time
4. Navigate to patient's test page (/ecp/patient/:id/test)
5. Begin examination recording:
   
   SECTION 1 - Chief Complaint:
   - Patient's main concern
   - Symptoms
   
   SECTION 2 - History:
   - Medical history
   - Ocular history
   - Medications
   - Allergies
   
   SECTION 3 - Visual Acuity:
   - Distance vision OD/OS
   - Near vision OD/OS
   - With/without correction
   
   SECTION 4 - Refraction:
   - Sphere, Cylinder, Axis (OD/OS)
   - Add power for near vision
   - Prism if needed
   
   SECTION 5 - Binocular Vision:
   - Cover test results
   - Stereopsis
   - Eye movements
   
   SECTION 6 - Ocular Health:
   - Anterior segment exam
   - Posterior segment exam
   - IOP (intraocular pressure)
   
   SECTION 7 - Diagnosis:
   - Clinical findings
   - ICD-10 codes
   
   SECTION 8 - Plan:
   - Treatment recommendations
   - Prescription details
   - Follow-up schedule

6. Save examination record
7. Generate prescription if needed
8. Print or email examination report to patient
9. Schedule follow-up appointment if required

Expected Time: 30-45 minutes for comprehensive exam
Record Storage: Permanent in database

1.2 LAB TECHNICIAN WORKFLOWS
-----------------------------

WORKFLOW 5: ORDER QUEUE MANAGEMENT
-----------------------------------
Scenario: Lab technician views and processes incoming orders

Step-by-Step:
1. Login with lab_tech credentials
2. Navigate to Lab Dashboard (/lab/dashboard)
3. View production queue with orders sorted by priority
4. Orders displayed with:
   - Order ID
   - Patient Name
   - Prescription complexity indicator
   - Current status
   - Time in current status
   - Assigned technician
5. Select order to begin work
6. Update order status to "in_production"
7. View detailed prescription and specifications
8. Follow manufacturing instructions
9. Log any issues or consults needed
10. Update status throughout production process:
    - In Production â†’ Quality Check â†’ Shipped
11. Add notes at each status change
12. Mark order complete when shipped

Status Update Actions:
- Start Production: pending â†’ in_production
- Send to QC: in_production â†’ quality_check
- Approve & Ship: quality_check â†’ shipped
- Complete: shipped â†’ completed
- Hold: any status â†’ on_hold
- Cancel: any status â†’ cancelled

Expected Time per Order: 30-120 minutes (depending on complexity)
Real-time Updates: Yes (dashboard auto-refreshes)

WORKFLOW 6: QUALITY CONTROL INSPECTION
---------------------------------------
Scenario: Order needs quality check before shipping

Step-by-Step:
1. Order arrives in quality_check status
2. Lab engineer retrieves order from queue
3. Inspect lenses for:
   - Prescription accuracy (verify measurements)
   - Surface quality (scratches, defects)
   - Coating quality (uniformity, adhesion)
   - Edge finish
   - Fit to frame
4. If PASS:
   - Update status to "shipped"
   - Generate shipping label
   - Notify ECP via email
   - Create order timeline entry
5. If FAIL:
   - Create Quality Issue record:
     * Issue type (surface_defect, coating_defect, etc.)
     * Severity (1-10)
     * Description
     * Photos/documentation
   - Update order status to "on_hold"
   - Assign to engineer for review
   - Log in quality_issues table
6. Engineer reviews and determines action:
   - Rework order
   - Scrap and restart
   - Contact ECP for clarification

Quality Check Criteria:
âœ“ Prescription within Â±0.12D tolerance
âœ“ No visible scratches or defects
âœ“ Coating uniform and complete
âœ“ Edges smooth and polished
âœ“ Proper fit to frame specifications

Expected Time: 15-30 minutes per order
Pass Rate Target: >95%

WORKFLOW 7: TECHNICAL CONSULTATION
-----------------------------------
Scenario: Complex prescription needs engineering review

Step-by-Step:
1. Lab tech encounters challenging order
2. Navigate to Consults section
3. Create new consult log:
   - Associate with order ID
   - Set priority (normal/high/urgent)
   - Describe question or issue
   - Add relevant details or photos
4. System notifies available engineers
5. Engineer reviews consult:
   - Examines order details
   - Researches technical requirements
   - Provides detailed answer
6. Engineer updates consult:
   - Add answer/solution
   - Mark status as "resolved"
   - Add to knowledge base if applicable
7. Lab tech receives notification
8. Implements engineer's recommendations
9. Consult closed with resolution logged

Consult Categories:
- Complex prescription calculation
- Material selection advice
- Coating compatibility
- Frame fitting issues
- Equipment calibration questions
- Quality control interpretation

Response Time:
- Normal: 2-4 hours
- High: 1-2 hours
- Urgent: <30 minutes

1.3 SUPPLIER WORKFLOWS
----------------------

WORKFLOW 8: PURCHASE ORDER FULFILLMENT
---------------------------------------
Scenario: Supplier receives PO from lab

Step-by-Step:
1. Login with supplier credentials
2. Navigate to Supplier Dashboard (/supplier/dashboard)
3. View incoming purchase orders
4. Click on new PO to view details:
   - PO number
   - Lab company information
   - Line items with quantities and prices
   - Delivery requirements
   - Customer reference
5. Download PO PDF if needed
6. Update PO status to "acknowledged":
   - Confirm receipt
   - Add estimated delivery date
   - Add any notes
7. Prepare order for shipment
8. Update status to "in_transit":
   - Add tracking number
   - Add carrier information
   - System sends email notification to lab
9. Upon delivery, update status to "delivered"
10. System logs completion in PO history

PO Status Progression:
draft â†’ sent â†’ acknowledged â†’ in_transit â†’ delivered

Communication:
- Email notifications at each status change
- Lab can view real-time status
- Comments/notes visible to both parties

Expected Turnaround: 3-7 business days

WORKFLOW 9: TECHNICAL DOCUMENT MANAGEMENT
------------------------------------------
Scenario: Supplier maintains product documentation

Step-by-Step:
1. Navigate to Technical Documents section
2. Upload new documents:
   - Select document type:
     * Spec Sheet (product specifications)
     * Certificate (certifications, compliance)
     * SDS (Safety Data Sheets)
     * Compliance (regulatory documents)
     * Other
   - Choose file (PDF, DOC, etc.)
   - Add title and description
   - Associate with products if applicable
3. Submit for storage
4. Documents accessible to all partner labs
5. Update documents when new versions available
6. Maintain document library organized by category

Document Types:
âœ“ Product specifications
âœ“ Safety data sheets (SDS)
âœ“ Certificates of analysis
âœ“ Compliance certifications
âœ“ Material composition sheets
âœ“ Handling instructions

Version Control: Manual (upload new version)
Access: All labs with approved relationship

1.4 ADMINISTRATOR WORKFLOWS
----------------------------

WORKFLOW 10: USER APPROVAL & MANAGEMENT
----------------------------------------
Scenario: Admin reviews and approves new user registrations

Step-by-Step:
1. Login with admin credentials
2. Navigate to Admin Dashboard (/admin/dashboard)
3. View user statistics:
   - Total users
   - Active users
   - Pending approvals (highlighted)
   - Suspended accounts
   - Users by role
4. Click on "Pending Approvals" section
5. Review pending users:
   - Name, email, organization
   - Requested role
   - Registration date
6. For each user, decide:
   
   APPROVE:
   - Click "Approve" button
   - User account status changes to "active"
   - User receives email notification
   - User can now login and access system
   
   REJECT:
   - Click "Reject" button
   - Add reason for rejection
   - User receives email with reason
   - Account remains in pending state or deleted
   
   SUSPEND (for active users):
   - Click "Suspend" button
   - Add reason for suspension
   - User account locked
   - User cannot login
   - Email notification sent

7. Manage user roles:
   - Click on user to view details
   - Add or remove roles
   - Change primary role
   - Save changes

Admin Actions Available:
âœ“ Approve pending users
âœ“ Suspend active users
âœ“ Reactivate suspended users
âœ“ Change user roles
âœ“ Delete users (cascade delete company data)
âœ“ View user activity logs
âœ“ Search/filter users

Security Considerations:
- All actions logged with timestamp and admin user
- Email notifications for all status changes
- Cannot delete last admin user
- Suspended users' sessions terminated immediately

Expected Time: 2-3 minutes per user review

WORKFLOW 11: COMPANY ONBOARDING (Multi-Tenant)
-----------------------------------------------
Scenario: Admin sets up new company in the system

Step-by-Step:
1. Receive company registration request
2. Navigate to Companies section (/api/companies)
3. Create new company record:
   - Company name
   - Company type (ECP/Lab/Supplier/Hybrid)
   - Contact email
   - Phone, website
   - Address
   - Registration number
   - GOC number (for ECPs)
   - Tax ID
4. Set subscription plan:
   - Free ECP Plan
   - Full Experience Plan
5. Configure company settings:
   - Branding (logo, colors)
   - Timezone, currency
   - Notification preferences
   - AI settings
6. Create company admin user:
   - Assign company_admin role
   - Link to company_id
   - Approve account immediately
7. Send welcome email with:
   - Login credentials
   - Setup instructions
   - Support contact information
8. Company admin can now:
   - Invite team members
   - Configure company preferences
   - Begin using system

Manual SQL Setup (Current Requirement):
```sql
-- Create company
INSERT INTO companies (name, type, status, email, subscription_plan)
VALUES ('Acme Optical', 'ecp', 'active', 'admin@acmeoptical.com', 'full');

-- Get company ID
SELECT id FROM companies WHERE email = 'admin@acmeoptical.com';

-- Assign user to company
UPDATE users 
SET company_id = 'company-uuid-here' 
WHERE email = 'user@acmeoptical.com';
```

Expected Setup Time: 15-30 minutes per company

1.5 CROSS-ROLE WORKFLOWS
-------------------------

WORKFLOW 12: ORDER LIFECYCLE (End-to-End)
------------------------------------------
Complete order journey from submission to delivery

STAGE 1: Order Submission (ECP)
- ECP examines patient
- Creates patient record (if new)
- Submits order with prescription
- Uploads OMA file (optional)
- Status: pending

STAGE 2: Order Acknowledgment (Lab)
- Lab receives order notification
- Reviews order for completeness
- Assigns to production queue
- Sends confirmation to ECP
- Status: pending â†’ in_production

STAGE 3: Manufacturing (Lab Tech)
- Lab tech retrieves order
- Checks material availability
- Begins lens surfacing/edging
- Applies coatings
- Updates status periodically
- Status: in_production

STAGE 4: Quality Control (Engineer)
- QC inspector receives finished lenses
- Performs measurement verification
- Inspects for defects
- If issues found â†’ creates quality issue
- If pass â†’ approves for shipping
- Status: in_production â†’ quality_check

STAGE 5: Shipping (Lab)
- Packaging and labeling
- Creates shipping label
- Updates tracking information
- Sends shipment notification to ECP
- Status: quality_check â†’ shipped

STAGE 6: Delivery & Completion (ECP)
- ECP receives package
- Verifies order correctness
- Marks as received in system
- Schedules patient for dispensing
- Status: shipped â†’ completed

STAGE 7: Dispensing (ECP)
- Patient arrives for pickup
- ECP fits lenses to patient
- Creates dispense record (GOC compliance)
- Provides aftercare instructions
- Collects payment (if not prepaid)

Total Timeline: 7-14 days (typical)
Touchpoints: 6-8 status updates
Stakeholders: ECP, Lab Tech, Engineer, Patient

Real-time Visibility:
- ECP sees live status updates
- Patient can be notified via email/SMS (if configured)
- All status changes logged with timestamp

WORKFLOW 13: RETURN & REPLACEMENT PROCESS
------------------------------------------
Scenario: Patient experiences issues with lenses

Step-by-Step:
1. Patient reports issue to ECP
2. ECP evaluates the problem:
   - Non-adaptation (patient can't adjust)
   - Quality defect
   - Wrong prescription
   - Damaged in shipping

3. ECP creates return record:
   - Associate with original order
   - Select return reason
   - Select return type (warranty/remake/refund)
   - Add patient feedback and symptoms
   - Upload photos if relevant

4. System creates non_adapt or quality_issue record

5. Lab receives return notification

6. Options for resolution:
   
   REMAKE (No Charge):
   - Lab creates replacement order
   - Links to original order
   - Expedited production
   - Free shipping
   
   ADJUSTMENT:
   - Modify prescription
   - Recut lenses
   - Recoat if coating issue
   
   REFUND:
   - Approve refund request
   - Process via original payment method
   - Update order status to cancelled

7. Track replacement order separately

8. ECP dispenses replacement to patient

9. Follow up to ensure satisfaction

10. Close return ticket with resolution notes

Return Reasons:
- Non-adaptation (35%)
- Quality defect (20%)
- Wrong prescription (15%)
- Damaged (10%)
- Changed mind (20%)

Target Resolution Time: 5-7 business days
Cost Impact: Tracked in quality_issues table

================================================================================
2. IMPLEMENTATION & SETUP GUIDE
================================================================================

2.1 LOCAL DEVELOPMENT SETUP
----------------------------

PREREQUISITES:
- Node.js 18+ installed
- PostgreSQL 15+ installed (or Neon account)
- Git installed
- Text editor/IDE (VS Code recommended)

STEP 1: CLONE REPOSITORY
-------------------------
```bash
git clone https://github.com/newvantageco/ILS2.0.git
cd ILS2.0
```

STEP 2: INSTALL DEPENDENCIES
-----------------------------
```bash
npm install
```

Expected time: 2-5 minutes
Dependencies installed: 100+ packages

STEP 3: CONFIGURE ENVIRONMENT VARIABLES
----------------------------------------
Create `.env` file in project root:

```env
# Database
DATABASE_URL=postgresql://user:password@localhost:5432/ils_db

# Session Secret (generate random string)
SESSION_SECRET=your-super-secret-session-key-here

# Admin Setup Key (for first-time setup)
ADMIN_SETUP_KEY=your-admin-setup-key

# Master User (Optional - Auto-provisioning)
MASTER_USER_EMAIL=admin@yourcompany.com
MASTER_USER_PASSWORD=SecurePassword123!
MASTER_USER_FIRST_NAME=Admin
MASTER_USER_LAST_NAME=User
MASTER_USER_ORGANIZATION=Your Company

# Email Service (Resend)
RESEND_API_KEY=re_your_api_key_here

# Stripe (Payment Processing)
STRIPE_SECRET_KEY=sk_test_your_stripe_key
STRIPE_PUBLISHABLE_KEY=pk_test_your_stripe_key
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret

# External AI APIs (Optional)
OPENAI_API_KEY=sk-your-openai-key
ANTHROPIC_API_KEY=sk-ant-your-anthropic-key

# Node Environment
NODE_ENV=development
PORT=3000

# AWS S3 (Optional - for file storage)
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
AWS_REGION=us-east-1
AWS_S3_BUCKET=your-bucket-name

# Redis (Optional - for caching/jobs)
REDIS_URL=redis://localhost:6379
```

STEP 4: SET UP DATABASE
------------------------
```bash
# Run Drizzle migrations
npm run db:push
```

This creates all database tables, indexes, and enums.

Expected tables created: 60+
Expected time: 30-60 seconds

STEP 5: SEED INITIAL DATA (Optional)
-------------------------------------
Create a seed script or manually insert test data:

```sql
-- Create test company
INSERT INTO companies (id, name, type, status, email, subscription_plan)
VALUES ('test-company-uuid', 'Test Optical', 'ecp', 'active', 'test@example.com', 'full');

-- Create test user
INSERT INTO users (id, email, password_hash, first_name, last_name, organization, role, roles, account_status, company_id)
VALUES (
  'test-user-uuid',
  'test@example.com',
  '$2b$10$hashed_password_here',
  'Test',
  'User',
  'Test Optical',
  'ecp',
  ARRAY['ecp']::user_role[],
  'active',
  'test-company-uuid'
);
```

STEP 6: START DEVELOPMENT SERVER
---------------------------------
```bash
npm run dev
```

Server starts on: http://localhost:3000
Hot reload enabled: Yes

Expected console output:
```
Server listening on port 3000
Database connected
WebSocket server initialized
```

STEP 7: ACCESS APPLICATION
---------------------------
Open browser to: http://localhost:3000

First-time setup:
1. If master user configured â†’ login with those credentials
2. If not â†’ register new account via /email-signup
3. Admin must approve new accounts

STEP 8: VERIFY INSTALLATION
----------------------------
Check these endpoints:
- GET http://localhost:3000/health â†’ Should return { status: "healthy" }
- GET http://localhost:3000/api/auth/user (after login) â†’ Should return user object

2.2 PRODUCTION DEPLOYMENT SETUP
--------------------------------

OPTION A: DOCKER DEPLOYMENT
----------------------------
```dockerfile
# Dockerfile already exists in project
docker build -t ils:1.0.0 .
docker run -p 3000:3000 --env-file .env ils:1.0.0
```

OPTION B: KUBERNETES DEPLOYMENT
--------------------------------
See infrastructure/KUBERNETES_DEPLOYMENT_GUIDE.md for complete setup

Basic steps:
1. Create namespace
2. Configure secrets
3. Deploy PostgreSQL StatefulSet
4. Deploy Redis
5. Deploy ILS application
6. Configure ingress/load balancer
7. Set up monitoring

OPTION C: REPLIT DEPLOYMENT (Current)
--------------------------------------
Already configured with:
- Auto-deployment on push
- Neon PostgreSQL integration
- Environment variables in Secrets
- HTTPS enabled

OPTION D: TRADITIONAL VPS/CLOUD
--------------------------------
1. Provision Ubuntu 22.04 server
2. Install Node.js, PostgreSQL, Nginx
3. Clone repository
4. Configure environment variables
5. Build application: `npm run build`
6. Start with PM2: `pm2 start dist/index.js`
7. Configure Nginx reverse proxy
8. Set up SSL with Let's Encrypt

2.3 MULTI-TENANT SETUP GUIDE
-----------------------------

REQUIREMENT:
Before users can use AI features or company-specific features, they must be assigned to a company.

MANUAL SETUP (Current Method):
-------------------------------

Step 1: Create Company
```sql
INSERT INTO companies (
  name, 
  type, 
  status, 
  email, 
  phone,
  subscription_plan,
  ai_enabled
) VALUES (
  'Acme Optical Practice',
  'ecp',
  'active',
  'admin@acmeoptical.com',
  '555-0123',
  'full',
  true
);
```

Step 2: Get Company ID
```sql
SELECT id, name FROM companies WHERE email = 'admin@acmeoptical.com';
-- Copy the UUID returned
```

Step 3: Assign User to Company
```sql
UPDATE users 
SET company_id = 'company-uuid-from-step-2'
WHERE email = 'user@acmeoptical.com';
```

Step 4: User Logout and Login
User must logout and login again for company_id to be loaded in session.

AUTOMATED SETUP (Recommended for Production):
----------------------------------------------
Build a company onboarding page where:
1. Platform admin creates company via UI
2. Company admin user auto-created
3. Welcome email sent with login link
4. Company admin invites team members
5. Team members' company_id auto-assigned on approval

This requires building:
- /admin/companies page
- /admin/companies/new form
- API endpoints for company CRUD
- Email templates for onboarding

2.4 SUBSCRIPTION & BILLING SETUP
---------------------------------

STRIPE CONFIGURATION:
---------------------

Step 1: Create Stripe Account
- Sign up at stripe.com
- Get API keys from dashboard

Step 2: Create Products and Prices
```bash
# Create "Full Experience" product
stripe products create \
  --name="Full Experience Plan" \
  --description="Complete access to all ILS features"

# Create price for monthly billing
stripe prices create \
  --product=prod_XXXXX \
  --unit-amount=9900 \
  --currency=usd \
  --recurring-interval=month
```

Step 3: Configure Webhooks
- Go to Stripe Dashboard â†’ Developers â†’ Webhooks
- Add endpoint: https://yourdomain.com/api/webhooks/stripe
- Select events:
  * customer.subscription.created
  * customer.subscription.updated
  * customer.subscription.deleted
  * invoice.paid
  * invoice.payment_failed

Step 4: Update Environment Variables
```env
STRIPE_SECRET_KEY=sk_live_your_key
STRIPE_PUBLISHABLE_KEY=pk_live_your_key
STRIPE_WEBHOOK_SECRET=whsec_your_secret
```

Step 5: Test Subscription Flow
1. User selects subscription plan
2. Redirected to Stripe Checkout
3. Payment processed
4. Webhook updates company.stripe_subscription_id
5. User gains full feature access

================================================================================
3. DEVELOPMENT WORKFLOW
================================================================================

3.1 DEVELOPMENT BEST PRACTICES
-------------------------------

CODE ORGANIZATION:
- Frontend code: client/src/
- Backend code: server/
- Shared types: shared/
- Keep components small and focused
- Use TypeScript for all new code
- Follow existing file structure

NAMING CONVENTIONS:
- Components: PascalCase (e.g., OrderDetailsPage.tsx)
- Files: camelCase for utilities, PascalCase for components
- Database tables: snake_case (e.g., purchase_orders)
- API endpoints: kebab-case (e.g., /api/purchase-orders)
- Variables: camelCase (e.g., userId, orderStatus)

COMPONENT STRUCTURE:
```typescript
// Imports
import { useState } from 'react';
import { useQuery } from '@tanstack/react-query';

// Types
interface Props {
  orderId: string;
}

// Component
export function OrderDetails({ orderId }: Props) {
  // Hooks
  const [status, setStatus] = useState('loading');
  const { data, isLoading } = useQuery(...);
  
  // Event handlers
  const handleStatusChange = () => { ... };
  
  // Render
  return (
    <div>...</div>
  );
}
```

API ENDPOINT STRUCTURE:
```typescript
// Authentication check
app.get('/api/resource', isAuthenticated, async (req: any, res) => {
  try {
    // Extract user info
    const userId = req.user.claims.sub;
    const user = await storage.getUserWithRoles(userId);
    
    // Authorization check
    if (user.role !== 'admin') {
      return res.status(403).json({ message: 'Forbidden' });
    }
    
    // Multi-tenant filtering
    const companyId = user.companyId;
    
    // Database query
    const data = await storage.getResource(companyId);
    
    // Response
    res.json(data);
  } catch (error) {
    console.error('Error:', error);
    res.status(500).json({ message: 'Internal server error' });
  }
});
```

3.2 ADDING NEW FEATURES
------------------------

PROCESS FOR NEW DATABASE TABLE:
--------------------------------

1. Update schema.ts:
```typescript
export const myNewTable = pgTable("my_new_table", {
  id: varchar("id").primaryKey().default(sql`gen_random_uuid()`),
  companyId: varchar("company_id").notNull().references(() => companies.id),
  name: varchar("name").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
});
```

2. Create Zod validation schema:
```typescript
export const insertMyNewTableSchema = z.object({
  name: z.string().min(1, "Name is required"),
});
```

3. Run migration:
```bash
npm run db:push
```

4. Add storage methods in storage.ts:
```typescript
async getMyNewTable(companyId: string) {
  return await db
    .select()
    .from(myNewTable)
    .where(eq(myNewTable.companyId, companyId));
}
```

5. Create API endpoints in routes.ts or routes/*.ts

6. Create frontend components

7. Test thoroughly

PROCESS FOR NEW API ENDPOINT:
------------------------------

1. Define route in server/routes.ts or server/routes/*.ts:
```typescript
app.post('/api/my-resource', isAuthenticated, async (req: any, res) => {
  // Validate input
  const result = insertMyResourceSchema.safeParse(req.body);
  if (!result.success) {
    return res.status(400).json({ 
      message: fromZodError(result.error).message 
    });
  }
  
  // Get user context
  const userId = req.user.claims.sub;
  const user = await storage.getUserWithRoles(userId);
  
  // Create resource
  const resource = await storage.createMyResource({
    ...result.data,
    companyId: user.companyId,
    createdBy: userId,
  });
  
  res.status(201).json(resource);
});
```

2. Update client/src/api.ts with API call:
```typescript
export async function createMyResource(data: MyResourceData) {
  const response = await fetch('/api/my-resource', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data),
    credentials: 'include',
  });
  
  if (!response.ok) {
    throw new Error(await response.text());
  }
  
  return response.json();
}
```

3. Create React component with TanStack Query:
```typescript
export function MyResourcePage() {
  const queryClient = useQueryClient();
  
  const mutation = useMutation({
    mutationFn: createMyResource,
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['myResources'] });
    },
  });
  
  const handleSubmit = (data) => {
    mutation.mutate(data);
  };
  
  return <form onSubmit={handleSubmit}>...</form>;
}
```

4. Add route in client/src/App.tsx:
```typescript
<Route path="/my-resource" component={MyResourcePage} />
```

5. Add navigation link if needed

3.3 TESTING WORKFLOW
---------------------

RUNNING TESTS:
```bash
# All tests
npm test

# Unit tests only
npm run test:unit

# Integration tests only
npm run test:integration

# Component tests
npm run test:components

# E2E tests
npm run test:e2e

# With coverage
npm run test:coverage

# Watch mode
npm run test:watch
```

WRITING TESTS:
```typescript
// Unit test example
describe('OrderService', () => {
  it('should create order', async () => {
    const order = await orderService.create({...});
    expect(order.id).toBeDefined();
    expect(order.status).toBe('pending');
  });
});

// Integration test example
describe('POST /api/orders', () => {
  it('should create order', async () => {
    const response = await request(app)
      .post('/api/orders')
      .send({...})
      .expect(201);
    
    expect(response.body.id).toBeDefined();
  });
});

// Component test example
describe('OrderForm', () => {
  it('should submit form', async () => {
    render(<OrderForm />);
    
    fireEvent.change(screen.getByLabelText('Patient'), {
      target: { value: 'patient-id' }
    });
    
    fireEvent.click(screen.getByText('Submit'));
    
    await waitFor(() => {
      expect(mockMutation).toHaveBeenCalled();
    });
  });
});
```

3.4 GIT WORKFLOW
----------------

BRANCHING STRATEGY:
- main: Production-ready code
- develop: Integration branch
- feature/*: New features
- bugfix/*: Bug fixes
- hotfix/*: Production hotfixes

COMMIT MESSAGES:
Follow conventional commits:
- feat: New feature
- fix: Bug fix
- docs: Documentation
- style: Formatting
- refactor: Code restructuring
- test: Tests
- chore: Maintenance

Examples:
```
feat: add OMA file upload to order creation
fix: resolve patient search case sensitivity
docs: update API endpoint documentation
refactor: extract order validation logic
```

PULL REQUEST PROCESS:
1. Create feature branch from develop
2. Make changes and commit
3. Push branch to GitHub
4. Create pull request
5. Request review
6. Address feedback
7. Merge to develop
8. Deploy to staging for testing
9. Merge to main for production

================================================================================
4. TESTING STRATEGY
================================================================================

4.1 TEST TYPES
--------------

UNIT TESTS:
- Test individual functions and methods
- Mock external dependencies
- Fast execution
- High coverage target (>80%)

INTEGRATION TESTS:
- Test API endpoints
- Test database interactions
- Use test database
- Verify end-to-end flows

COMPONENT TESTS:
- Test React components
- Test user interactions
- Mock API calls
- Verify rendering

E2E TESTS:
- Test complete user workflows
- Use Playwright
- Test in real browser
- Verify critical paths

4.2 TESTING CHECKLIST FOR NEW FEATURES
---------------------------------------

Before deploying any new feature:

âœ“ Unit tests written for business logic
âœ“ Integration tests for API endpoints
âœ“ Component tests for UI components
âœ“ E2E test for critical user flow
âœ“ Manual testing completed
âœ“ Edge cases considered
âœ“ Error handling tested
âœ“ Performance tested (if applicable)
âœ“ Security reviewed
âœ“ Accessibility checked
âœ“ Mobile responsive verified
âœ“ Cross-browser tested
âœ“ Documentation updated

4.3 MANUAL TESTING SCENARIOS
-----------------------------

SCENARIO 1: Complete Order Workflow
1. Register as ECP
2. Create patient
3. Create order with prescription
4. Upload OMA file
5. Submit order
6. Login as lab tech
7. View order in queue
8. Update status to in_production
9. Update status to quality_check
10. Update status to shipped
11. Login as ECP
12. Verify order status updated

Expected Result: Order progresses through all statuses successfully

SCENARIO 2: POS Transaction
1. Login as ECP
2. Navigate to POS
3. Add product to cart
4. Set quantity
5. Apply discount
6. Select payment method
7. Complete transaction
8. Verify invoice created
9. Verify inventory decremented

Expected Result: Transaction completes, inventory updates

SCENARIO 3: Multi-Role Switching
1. Login as user with multiple roles
2. View role switcher dropdown
3. Switch from ECP to Lab Tech
4. Verify dashboard changes
5. Verify navigation menu updates
6. Switch back to ECP
7. Verify context restored

Expected Result: Role switching works seamlessly

================================================================================
5. DEPLOYMENT PROCESS
================================================================================

5.1 PRE-DEPLOYMENT CHECKLIST
-----------------------------

CODE QUALITY:
âœ“ All tests passing
âœ“ TypeScript compilation successful (npm run check)
âœ“ No console errors in browser
âœ“ Code reviewed by peer
âœ“ Documentation updated

SECURITY:
âœ“ No hardcoded secrets
âœ“ Environment variables configured
âœ“ HTTPS enabled
âœ“ CORS configured correctly
âœ“ Authentication tested
âœ“ Authorization verified

DATABASE:
âœ“ Migrations tested on staging
âœ“ Backup created
âœ“ Rollback plan prepared
âœ“ Indexes optimized

PERFORMANCE:
âœ“ API response times acceptable (<500ms)
âœ“ Page load times acceptable (<2s)
âœ“ Database queries optimized
âœ“ No N+1 queries

5.2 DEPLOYMENT STEPS
---------------------

STEP 1: PREPARE RELEASE
- Create release branch
- Update version number in package.json
- Update CHANGELOG.md
- Tag release in Git

STEP 2: BUILD
```bash
npm run build
```

STEP 3: DATABASE MIGRATION
```bash
# On production database
npm run db:push
```

STEP 4: DEPLOY CODE
- Upload built files to server
- Install production dependencies
- Restart application

STEP 5: VERIFY DEPLOYMENT
- Check health endpoint
- Test critical user flows
- Monitor logs for errors
- Check performance metrics

STEP 6: NOTIFY USERS
- Send deployment notification
- Update status page
- Monitor support channels

5.3 ROLLBACK PROCEDURE
-----------------------

If issues detected after deployment:

1. Revert code to previous version
2. Restart application
3. Rollback database migrations if needed
4. Verify system stability
5. Investigate issues
6. Plan hotfix if required

================================================================================
6. COMMON USE CASES
================================================================================

6.1 PRESCRIPTION ENTRY SCENARIOS
---------------------------------

USE CASE: Single Vision Distance
Prescription:
- OD: -2.00 -0.50 x 90
- OS: -2.25 -0.75 x 85
- PD: 63mm

Lens Selection:
- Type: Single vision
- Material: Polycarbonate
- Coating: Anti-reflective

USE CASE: Progressive Multifocal
Prescription:
- OD: -1.50 -0.25 x 180 Add +2.00
- OS: -1.75 -0.50 x 175 Add +2.00
- PD: 62/59mm (distance/near)

Lens Selection:
- Type: Progressive
- Material: 1.67 high-index
- Coating: Anti-reflective + Blue light filter

USE CASE: High Prescription
Prescription:
- OD: -8.00 -2.00 x 45
- OS: -8.50 -2.25 x 135
- PD: 60mm

Lens Selection:
- Type: Single vision
- Material: 1.74 high-index (thinnest)
- Coating: Anti-reflective + UV protection
- Frame: Full rim (to hide thick edges)

6.2 QUALITY CONTROL SCENARIOS
------------------------------

USE CASE: Surface Defect Detected
1. QC inspector finds scratch on lens
2. Create quality_issue:
   - Type: surface_defect
   - Severity: 8 (high)
   - Description: "2mm scratch on right lens surface"
3. Order status â†’ on_hold
4. Notify production manager
5. Decision: Remake lens
6. Create new production task
7. Expedite completion
8. Re-inspect
9. If pass â†’ ship to ECP

USE CASE: Prescription Tolerance Failure
1. Lensometer reading shows:
   - Ordered: -2.00 -0.50 x 90
   - Measured: -2.15 -0.50 x 90
   - Deviation: -0.15D (exceeds Â±0.12D tolerance)
2. Create quality_issue:
   - Type: measurement_error
   - Severity: 9 (critical)
3. Order â†’ on_hold
4. Engineer analysis:
   - Check equipment calibration
   - Verify prescription interpretation
   - Check material batch
5. Root cause: Equipment drift
6. Calibrate equipment
7. Remake order
8. Verify accuracy
9. Document in preventive_actions

6.3 CUSTOMER SERVICE SCENARIOS
-------------------------------

USE CASE: Patient Reports Dizziness
1. Patient calls ECP after receiving new glasses
2. ECP creates non_adapt record:
   - Symptoms: ["dizziness", "nausea", "headache"]
   - Patient feedback: "Can't wear glasses for more than 10 minutes"
3. ECP evaluates:
   - Check prescription accuracy
   - Verify lens type correct
   - Check frame fit
   - Review adaptation period guidance
4. Options:
   - Wait 1-2 weeks for adaptation
   - Adjust frame fit
   - Reduce prescription strength
   - Remake with different lens type
5. Track resolution
6. Follow up after 2 weeks

USE CASE: Damaged in Transit
1. ECP receives package with broken lenses
2. Photos documenting damage
3. Create return:
   - Return type: warranty
   - Return reason: damaged
4. Contact carrier for claim
5. Lab creates replacement order:
   - No charge to ECP
   - Expedited production
   - Premium shipping
6. Track replacement
7. Confirm delivery
8. Close return ticket

================================================================================
7. TROUBLESHOOTING GUIDE
================================================================================

7.1 COMMON ISSUES & SOLUTIONS
------------------------------

ISSUE: Cannot Login
Symptoms: Login form shows error or redirects to login
Solutions:
1. Check email/password correct
2. Verify account status is "active" (not pending/suspended)
3. Check database connection
4. Clear browser cookies
5. Check server logs for authentication errors
6. Verify SESSION_SECRET configured

ISSUE: Order Not Appearing in Queue
Symptoms: Created order doesn't show in lab dashboard
Solutions:
1. Verify order status is "pending" or "in_production"
2. Check user's company_id matches order's company_id
3. Verify user has correct role (lab_tech or engineer)
4. Check database for order existence
5. Refresh dashboard
6. Check WebSocket connection

ISSUE: OMA File Upload Fails
Symptoms: File upload shows error
Solutions:
1. Verify file is valid .oma format
2. Check file size (<10MB limit)
3. Verify server has write permissions to uploads directory
4. Check Multer configuration
5. Review server logs for parsing errors
6. Try different OMA file to isolate issue

ISSUE: PDF Generation Fails
Symptoms: Error when generating invoice or PO
Solutions:
1. Check PDFKit installation
2. Verify template data is complete
3. Check file system permissions
4. Review error logs
5. Test with minimal data
6. Check font files exist

ISSUE: Email Not Sending
Symptoms: No emails received
Solutions:
1. Verify RESEND_API_KEY configured
2. Check Resend dashboard for failures
3. Verify recipient email valid
4. Check spam folder
5. Review email service logs
6. Test with resend.com test mode

ISSUE: Multi-Tenant Data Leakage
Symptoms: Seeing other companies' data
Solutions:
1. Check all queries include company_id filter
2. Verify user.companyId is set
3. Review middleware for company scoping
4. Check database indexes
5. Test with multiple test companies
6. Review authorization logic

ISSUE: Performance Slow
Symptoms: Pages loading slowly, API timeouts
Solutions:
1. Check database query performance
2. Add missing indexes
3. Review N+1 query problems
4. Enable query logging
5. Check server resources (CPU, memory)
6. Optimize large data transfers
7. Implement caching
8. Check network latency

7.2 DATABASE ISSUES
-------------------

ISSUE: Migration Fails
```bash
# Check current schema
npm run db:push -- --dry-run

# Force migration (use with caution)
npm run db:push -- --force
```

ISSUE: Connection Pool Exhausted
Check DATABASE_URL includes connection pool settings:
```
postgresql://user:pass@host:5432/db?max_pool_size=20
```

ISSUE: Slow Queries
```sql
-- Identify slow queries
SELECT query, mean_exec_time, calls
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;

-- Add missing index
CREATE INDEX idx_table_column ON table(column);
```

7.3 AUTHENTICATION ISSUES
--------------------------

ISSUE: Session Expires Too Quickly
Update session configuration in server/index.ts:
```typescript
app.use(session({
  cookie: {
    maxAge: 1000 * 60 * 60 * 24 * 7, // 7 days
  },
}));
```

ISSUE: CORS Errors
Update CORS configuration:
```typescript
app.use(cors({
  origin: process.env.FRONTEND_URL,
  credentials: true,
}));
```

7.4 PRODUCTION ISSUES
----------------------

ISSUE: Server Crashes
1. Check error logs
2. Review recent deployments
3. Check resource usage
4. Verify environment variables
5. Test database connectivity
6. Review error tracking service

ISSUE: High Memory Usage
1. Check for memory leaks
2. Review connection pooling
3. Optimize large data processing
4. Implement pagination
5. Add memory limits
6. Monitor with profiler

ISSUE: API Rate Limiting Needed
Implement rate limiting:
```typescript
import rateLimit from 'express-rate-limit';

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100, // limit each IP to 100 requests per windowMs
});

app.use('/api/', limiter);
```

7.5 GETTING HELP
-----------------

When filing bug reports, include:
1. Steps to reproduce
2. Expected vs actual behavior
3. Error messages (full stack trace)
4. Environment (browser, OS, Node version)
5. User role and company context
6. Screenshots if relevant
7. Recent changes or deployments

Support Channels:
- GitHub Issues (for bugs)
- Developer documentation
- Team Slack/Discord
- Email support
- Phone support (enterprise customers)

================================================================================
END OF PART 3
================================================================================
Next: PART 4 - Future Roadmap, AI Features (Planned), and Appendices
