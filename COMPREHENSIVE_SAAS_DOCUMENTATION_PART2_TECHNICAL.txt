================================================================================
INTEGRATED LENS SYSTEM (ILS) - COMPREHENSIVE SAAS DOCUMENTATION
PART 2: TECHNICAL ARCHITECTURE, DATABASE SCHEMA & API REFERENCE
================================================================================
Generated: November 2, 2025
Repository: ILS2.0 (newvantageco)
Version: 1.0.0

================================================================================
TABLE OF CONTENTS - PART 2
================================================================================
1. Technology Stack
2. System Architecture
3. Database Schema (Complete)
4. API Endpoints Reference
5. File Structure & Organization
6. Services & Business Logic
7. Security Implementation

================================================================================
1. TECHNOLOGY STACK
================================================================================

1.1 FRONTEND TECHNOLOGIES
--------------------------
Core Framework:
- React 18.3.1 (Component-based UI)
- TypeScript 5.6.3 (Type safety)
- Vite 5.4.20 (Build tool, fast HMR)

State Management & Data Fetching:
- TanStack Query 5.60.5 (Server state management, caching)
- React Hook Form 7.55.0 (Form handling)
- Zod 3.24.2 (Schema validation)

Routing:
- Wouter 3.3.5 (Lightweight routing, ~2KB)

UI Components & Styling:
- shadcn/ui (Radix UI primitives)
- Radix UI Components (40+ packages for accessible components)
- Tailwind CSS 3.4.18 (Utility-first styling)
- @tailwindcss/typography (Rich text styling)
- Framer Motion 11.18.2 (Animations)
- Lucide React 0.453.0 (Icon library)
- React Icons 5.4.0 (Additional icons)

Component Libraries:
- @radix-ui/react-* (Accordion, Dialog, Dropdown, Select, etc.)
- Embla Carousel React 8.6.0 (Carousels)
- React Day Picker 8.10.1 (Date picker)
- Recharts 2.15.4 (Data visualization)
- React Resizable Panels 2.1.7 (Resizable layouts)
- Vaul 1.1.2 (Drawer component)

Utilities:
- date-fns 3.6.0 (Date manipulation)
- clsx 2.1.1 (Conditional classes)
- class-variance-authority 0.7.1 (Component variants)
- tailwind-merge 2.6.0 (Tailwind class merging)

Theming:
- next-themes 0.4.6 (Dark/light mode)

1.2 BACKEND TECHNOLOGIES
-------------------------
Runtime & Framework:
- Node.js (ES Modules)
- Express 4.21.2 (Web framework)
- TypeScript 5.6.3 (Type safety)
- tsx 4.20.5 (TypeScript execution)

Database:
- PostgreSQL (via Neon serverless)
- Drizzle ORM 0.44.7 (Type-safe queries)
- Drizzle Kit 0.31.5 (Migrations)
- pg 8.16.3 (PostgreSQL client)

Authentication:
- Passport.js 0.7.0 (Auth middleware)
- Passport Local 1.0.0 (Local strategy)
- OpenID Client 6.8.1 (Replit Auth/OIDC)
- bcrypt 6.0.0 (Password hashing)
- Express Session 1.18.1 (Session management)
- connect-pg-simple 10.0.0 (PostgreSQL session store)

File Handling:
- Multer 2.0.2 (File uploads)
- PDFKit 0.17.2 (PDF generation)

Email:
- Resend 6.2.2 (Email service)
- Nodemailer 7.0.10 (Email sending)

Validation:
- Zod 3.24.2 (Schema validation)
- @sinclair/typebox 0.34.41 (TypeBox schemas)

Utilities:
- Axios 1.13.0 (HTTP client)
- CORS 2.8.5 (Cross-origin requests)
- ws 8.18.0 (WebSocket support)
- qrcode 1.5.4 (QR code generation)

AI/ML Libraries (Installed but partially used):
- OpenAI 6.7.0 (OpenAI API client)
- @anthropic-ai/sdk 0.68.0 (Claude API)
- @tensorflow/tfjs-node 4.22.0 (TensorFlow for Node)
- simple-statistics 7.8.8 (Statistical functions)
- regression 2.0.1 (Regression analysis)

Payment Processing:
- Stripe 19.1.0 (Payment gateway)

Parsing:
- dicom-parser 1.8.21 (DICOM medical imaging)

Caching & Background Jobs (Optional):
- ioredis 5.4.2 (Redis client)
- bullmq 5.35.4 (Job queue)
- @bull-board/* (Job dashboard)

Cloud Storage (Optional):
- @aws-sdk/client-s3 3.700.0 (S3 integration)
- @aws-sdk/s3-request-presigner 3.700.0

1.3 DEVELOPMENT & TESTING
--------------------------
Testing:
- Jest 29.7.0 (Test runner)
- @testing-library/react 16.3.0 (React testing)
- @testing-library/jest-dom 6.9.1 (DOM matchers)
- Vitest 4.0.5 (Component testing)
- Playwright 1.56.1 (E2E testing)
- Supertest 7.1.4 (API testing)

Build Tools:
- esbuild 0.25.0 (Fast bundling)
- Vite 5.4.20 (Frontend build)
- tsx 4.20.5 (TypeScript execution)

Code Quality:
- TypeScript 5.6.3 (Type checking)
- ESLint (Linting - to be configured)

Environment:
- dotenv 17.2.3 (Environment variables)

1.4 INFRASTRUCTURE & DEPLOYMENT
--------------------------------
Current Deployment:
- Replit (Development)
- Neon PostgreSQL (Serverless database)

Planned Production Stack:
- Docker (Containerization)
- Kubernetes/AWS EKS (Orchestration)
- AWS RDS (PostgreSQL)
- AWS ElastiCache (Redis)
- AWS S3 (File storage)
- AWS DynamoDB (NoSQL)
- GitHub Actions (CI/CD)
- Terraform/CloudFormation (IaC)

Monitoring (Planned):
- Prometheus (Metrics)
- Grafana (Visualization)
- AWS CloudWatch (Logs)

================================================================================
2. SYSTEM ARCHITECTURE
================================================================================

2.1 CURRENT ARCHITECTURE (Monolithic)
--------------------------------------

┌─────────────────────────────────────────────────────────────┐
│                         CLIENT TIER                          │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  React SPA (Vite + TypeScript)                        │  │
│  │  - Component-based UI                                 │  │
│  │  - TanStack Query (State Management)                  │  │
│  │  - Wouter (Routing)                                   │  │
│  │  - shadcn/ui + Radix UI (Components)                  │  │
│  │  - Tailwind CSS (Styling)                             │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                             ↓ HTTP/WebSocket
┌─────────────────────────────────────────────────────────────┐
│                      APPLICATION TIER                        │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  Express.js Server (Node.js + TypeScript)            │  │
│  │                                                        │  │
│  │  ┌──────────────────────────────────────────────┐    │  │
│  │  │  Authentication Middleware                    │    │  │
│  │  │  - Passport.js                                │    │  │
│  │  │  - Session Management                         │    │  │
│  │  └──────────────────────────────────────────────┘    │  │
│  │                                                        │  │
│  │  ┌──────────────────────────────────────────────┐    │  │
│  │  │  Route Handlers (routes.ts + routes/*)       │    │  │
│  │  │  - /api/orders                                │    │  │
│  │  │  - /api/patients                              │    │  │
│  │  │  - /api/suppliers                             │    │  │
│  │  │  - /api/pos                                   │    │  │
│  │  │  - /api/admin                                 │    │  │
│  │  │  - /api/ecp                                   │    │  │
│  │  │  - /api/examinations                          │    │  │
│  │  │  - /api/companies                             │    │  │
│  │  │  - /api/analytics                             │    │  │
│  │  └──────────────────────────────────────────────┘    │  │
│  │                                                        │  │
│  │  ┌──────────────────────────────────────────────┐    │  │
│  │  │  Business Logic Services                      │    │  │
│  │  │  - PDFService (Invoice/report generation)    │    │  │
│  │  │  - EmailService (Notifications)              │    │  │
│  │  │  - LabWorkTicketService                       │    │  │
│  │  │  - ExaminationFormService                     │    │  │
│  │  │  - WebSocketService (Real-time updates)      │    │  │
│  │  └──────────────────────────────────────────────┘    │  │
│  │                                                        │  │
│  │  ┌──────────────────────────────────────────────┐    │  │
│  │  │  Data Access Layer (storage.ts)              │    │  │
│  │  │  - Drizzle ORM                                │    │  │
│  │  │  - Type-safe queries                          │    │  │
│  │  │  - Company-scoped data access                 │    │  │
│  │  └──────────────────────────────────────────────┘    │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                             ↓ SQL
┌─────────────────────────────────────────────────────────────┐
│                        DATABASE TIER                         │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  PostgreSQL (Neon Serverless)                         │  │
│  │  - 60+ tables                                          │  │
│  │  - Multi-tenant (company_id scoping)                  │  │
│  │  - JSONB for flexible data                            │  │
│  │  - Full-text search                                   │  │
│  │  - Indexes for performance                            │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────┐
│                    EXTERNAL SERVICES                         │
│  - Stripe (Payments)                                         │
│  - Resend (Email)                                            │
│  - OpenAI/Anthropic (AI APIs - planned)                     │
│  - AWS S3 (File storage - planned)                          │
└─────────────────────────────────────────────────────────────┘

2.2 PLANNED MICROSERVICES ARCHITECTURE
---------------------------------------

┌─────────────────────────────────────────────────────────────┐
│                      API GATEWAY (AWS)                       │
│  - Request routing                                           │
│  - Authentication                                            │
│  - Rate limiting                                             │
│  - Load balancing                                            │
└─────────────────────────────────────────────────────────────┘
           ↓              ↓              ↓              ↓
┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│   Auth       │ │   Order      │ │   POS        │ │   Practice   │
│   Service    │ │   Service    │ │   Service    │ │   Service    │
│              │ │              │ │              │ │              │
│ - Auth       │ │ - Orders     │ │ - Products   │ │ - Patients   │
│ - Users      │ │ - LIMS       │ │ - Invoices   │ │ - Exams      │
│ - Sessions   │ │   Integration│ │ - Billing    │ │ - Test Rooms │
└──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘
       ↓                ↓                ↓                ↓
┌─────────────────────────────────────────────────────────────┐
│               Shared Services & Data Stores                  │
│  - PostgreSQL (RDS)                                          │
│  - Redis (ElastiCache)                                       │
│  - DynamoDB                                                  │
│  - S3 (File Storage)                                         │
└─────────────────────────────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────┐
│                   LIMS (Lab Information                      │
│                   Management System)                         │
│  - Single Source of Truth for Manufacturing                 │
│  - Job Management                                            │
│  - Catalog Management                                        │
│  - Webhooks for Status Updates                              │
└─────────────────────────────────────────────────────────────┘

2.3 DATA FLOW PATTERNS
-----------------------

Order Submission Flow:
Client → POST /api/orders → Order Validation → Database Insert 
→ LIMS Integration (planned) → Response with Order ID

Status Update Flow:
Lab Dashboard → PATCH /api/orders/:id/status → Update Database 
→ WebSocket Broadcast → Real-time UI Update

Authentication Flow:
Login Form → POST /api/auth/login → Passport Verify 
→ Session Create → Set Cookie → Redirect to Dashboard

Multi-Tenant Data Access:
Request → isAuthenticated Middleware → Extract user.companyId 
→ Query with WHERE company_id = ? → Filtered Results

File Upload Flow:
File Input → Multer Middleware → Validate File Type/Size 
→ Save to Disk/S3 → Store Metadata in Database → Return URL

PDF Generation Flow:
Request → Gather Data → PDFKit Template → Generate PDF 
→ Save/Stream → Email (optional) → Return PDF URL/Buffer

================================================================================
3. DATABASE SCHEMA (COMPLETE)
================================================================================

Total Tables: 60+ tables
Database Engine: PostgreSQL 15+
ORM: Drizzle ORM with TypeScript

3.1 CORE TABLES
---------------

USERS TABLE
-----------
Table: users
Purpose: Store all user accounts across all companies
Key Fields:
- id: varchar (UUID, Primary Key)
- email: varchar (unique, normalized)
- password_hash: text (bcrypt hashed)
- first_name: varchar
- last_name: varchar
- organization: varchar
- role: user_role enum (default role)
- roles: user_role[] (array of all assigned roles)
- account_status: account_status enum (pending/active/suspended)
- status_reason: text (suspension/rejection reason)
- company_id: varchar → companies.id (multi-tenant scoping)
- subscription_plan: subscription_plan enum (full/free_ecp)
- created_at: timestamp
- updated_at: timestamp
- last_login: timestamp
- email_verified: boolean
- phone: varchar
- profile_image_url: text
- preferences: jsonb
- metadata: jsonb

Indexes:
- idx_users_email (email)
- idx_users_company (company_id)
- idx_users_account_status (account_status)

COMPANIES TABLE
---------------
Table: companies
Purpose: Multi-tenant company/organization records
Key Fields:
- id: varchar (UUID, Primary Key)
- name: text (company name)
- type: company_type enum (ecp/lab/supplier/hybrid)
- status: company_status enum (active/suspended/pending_approval/deactivated)
- email: varchar
- phone: varchar
- website: varchar
- address: jsonb
- registration_number: varchar
- goc_number: varchar (for ECPs)
- tax_id: varchar
- subscription_plan: subscription_plan enum
- subscription_start_date: timestamp
- subscription_end_date: timestamp
- billing_email: varchar
- stripe_customer_id: varchar
- stripe_subscription_id: varchar
- stripe_subscription_status: varchar
- stripe_current_period_end: timestamp
- free_trial_end_date: timestamp
- subscription_cancelled_at: timestamp
- is_subscription_exempt: boolean
- company_logo_url: text
- company_letterhead_url: text
- branding_settings: jsonb
- settings: jsonb
- preferences: jsonb
- ai_enabled: boolean
- ai_model: varchar
- use_external_ai: boolean
- ai_learning_progress: integer (0-100)
- created_at: timestamp
- updated_at: timestamp

Indexes:
- idx_companies_status (status)
- idx_companies_type (type)

PATIENTS TABLE
--------------
Table: patients
Purpose: Patient demographic records
Key Fields:
- id: varchar (UUID, Primary Key)
- company_id: varchar → companies.id
- customer_number: varchar (CUST-XXXXXX, auto-generated)
- first_name: varchar
- last_name: varchar
- date_of_birth: varchar
- email: varchar
- phone: varchar
- address: jsonb
- emergency_contact: jsonb
- medical_history: jsonb
- notes: text
- created_at: timestamp
- updated_at: timestamp
- created_by: varchar → users.id

Indexes:
- idx_patients_company (company_id)
- idx_patients_customer_number (customer_number)

Sequences:
- patient_customer_number_seq (for CUST-XXXXXX generation)

ORDERS TABLE
------------
Table: orders
Purpose: Lens orders from ECPs to labs
Key Fields:
- id: varchar (UUID, Primary Key)
- company_id: varchar → companies.id
- patient_id: varchar → patients.id
- status: order_status enum (pending/in_production/quality_check/shipped/completed/on_hold/cancelled)
- prescription: jsonb (OD/OS sphere, cylinder, axis, add, PD)
- lens_specifications: jsonb (type, material, coating)
- frame_specifications: jsonb (measurements, type)
- oma_file_data: jsonb (parsed OMA data)
- customer_reference: varchar
- notes: text
- created_at: timestamp
- updated_at: timestamp
- created_by: varchar → users.id
- assigned_to: varchar → users.id
- priority: varchar
- estimated_completion: timestamp
- completed_at: timestamp
- shipped_at: timestamp

Indexes:
- idx_orders_company (company_id)
- idx_orders_patient (patient_id)
- idx_orders_status (status)
- idx_orders_created_at (created_at)

PRODUCTS TABLE (POS)
--------------------
Table: products
Purpose: Inventory items for over-the-counter sales
Key Fields:
- id: varchar (UUID, Primary Key)
- company_id: varchar → companies.id
- sku: varchar (unique per company)
- name: varchar
- description: text
- product_type: product_type enum (frame/contact_lens/solution/service)
- price: decimal(10,2)
- cost: decimal(10,2)
- stock_quantity: integer
- low_stock_threshold: integer
- metadata: jsonb
- active: boolean
- created_at: timestamp
- updated_at: timestamp

Indexes:
- idx_products_company (company_id)
- idx_products_sku (sku)

INVOICES TABLE
--------------
Table: invoices
Purpose: Sales invoices for POS transactions
Key Fields:
- id: varchar (UUID, Primary Key)
- company_id: varchar → companies.id
- invoice_number: varchar
- patient_id: varchar → patients.id
- status: invoice_status enum (draft/paid/void)
- subtotal: decimal(10,2)
- tax: decimal(10,2)
- discount: decimal(10,2)
- total: decimal(10,2)
- payment_method: payment_method enum (cash/card/mixed)
- payment_details: jsonb
- notes: text
- created_at: timestamp
- created_by: varchar → users.id

Indexes:
- idx_invoices_company (company_id)
- idx_invoices_patient (patient_id)
- idx_invoices_status (status)

INVOICE_LINE_ITEMS TABLE
-------------------------
Table: invoice_line_items
Purpose: Line items for invoices
Key Fields:
- id: varchar (UUID, Primary Key)
- invoice_id: varchar → invoices.id
- product_id: varchar → products.id
- description: varchar
- quantity: integer
- unit_price: decimal(10,2)
- tax_rate: decimal(5,2)
- discount: decimal(10,2)
- total: decimal(10,2)

3.2 SUPPLIER & PURCHASE ORDER TABLES
-------------------------------------

SUPPLIERS TABLE
---------------
Table: suppliers
Purpose: Supplier/vendor information
Key Fields:
- id: varchar (UUID, Primary Key)
- company_id: varchar → companies.id
- name: varchar
- contact_name: varchar
- email: varchar
- phone: varchar
- address: jsonb
- account_number: varchar
- status: varchar (active/inactive)
- notes: text
- created_at: timestamp
- updated_at: timestamp

PURCHASE_ORDERS TABLE
---------------------
Table: purchase_orders
Purpose: Purchase orders to suppliers
Key Fields:
- id: varchar (UUID, Primary Key)
- company_id: varchar → companies.id
- supplier_id: varchar → suppliers.id
- po_number: varchar
- status: po_status enum (draft/sent/acknowledged/in_transit/delivered/cancelled)
- total_amount: decimal(10,2)
- customer_reference: varchar
- notes: text
- delivery_notes: text
- created_at: timestamp
- created_by: varchar → users.id
- sent_at: timestamp
- acknowledged_at: timestamp
- delivered_at: timestamp

PO_LINE_ITEMS TABLE
-------------------
Table: po_line_items
Purpose: Line items for purchase orders
Key Fields:
- id: varchar (UUID, Primary Key)
- purchase_order_id: varchar → purchase_orders.id
- description: varchar
- quantity: integer
- unit_price: decimal(10,2)
- total: decimal(10,2)

TECHNICAL_DOCUMENTS TABLE
--------------------------
Table: technical_documents
Purpose: Technical specs, certifications, SDS, etc.
Key Fields:
- id: varchar (UUID, Primary Key)
- company_id: varchar → companies.id
- supplier_id: varchar → suppliers.id
- title: varchar
- document_type: document_type enum (spec_sheet/certificate/sds/compliance/other)
- file_url: text
- file_name: varchar
- file_size: integer
- description: text
- uploaded_by: varchar → users.id
- uploaded_at: timestamp

3.3 EYE EXAMINATION & CLINICAL TABLES
--------------------------------------

EYE_EXAMINATIONS TABLE
----------------------
Table: eye_examinations
Purpose: Clinical eye exam records
Key Fields:
- id: varchar (UUID, Primary Key)
- company_id: varchar → companies.id
- patient_id: varchar → patients.id
- practitioner_id: varchar → users.id
- test_room_id: varchar → test_rooms.id
- status: examination_status enum (in_progress/finalized)
- examination_date: timestamp
- chief_complaint: text
- history: jsonb
- visual_acuity: jsonb
- refraction: jsonb
- binocular_vision: jsonb
- ocular_health: jsonb
- diagnosis: text
- plan: text
- notes: text
- created_at: timestamp
- updated_at: timestamp

PRESCRIPTIONS TABLE
-------------------
Table: prescriptions
Purpose: Prescription records (separate from orders)
Key Fields:
- id: varchar (UUID, Primary Key)
- company_id: varchar → companies.id
- patient_id: varchar → patients.id
- examination_id: varchar → eye_examinations.id
- prescription_type: varchar (spectacles/contact_lenses/both)
- prescription_data: jsonb
- expiry_date: timestamp
- issued_by: varchar → users.id
- issued_at: timestamp
- dispensed: boolean
- dispensed_at: timestamp

TEST_ROOMS TABLE
----------------
Table: test_rooms
Purpose: Examination room management
Key Fields:
- id: varchar (UUID, Primary Key)
- company_id: varchar → companies.id
- name: varchar
- description: text
- capacity: integer
- equipment_ids: varchar[] (array of equipment IDs)
- active: boolean
- created_at: timestamp
- updated_at: timestamp

TEST_ROOM_BOOKINGS TABLE
------------------------
Table: test_room_bookings
Purpose: Room booking/scheduling
Key Fields:
- id: varchar (UUID, Primary Key)
- company_id: varchar → companies.id
- test_room_id: varchar → test_rooms.id
- patient_id: varchar → patients.id
- practitioner_id: varchar → users.id
- start_time: timestamp
- end_time: timestamp
- status: varchar (scheduled/in_progress/completed/cancelled)
- notes: text
- created_by: varchar → users.id
- created_at: timestamp

3.4 LAB & QUALITY CONTROL TABLES
---------------------------------

CONSULT_LOGS TABLE
------------------
Table: consult_logs
Purpose: Technical consultations between lab staff
Key Fields:
- id: varchar (UUID, Primary Key)
- company_id: varchar → companies.id
- order_id: varchar → orders.id
- logged_by: varchar → users.id
- priority: consult_priority enum (normal/high/urgent)
- question: text
- answer: text
- status: varchar (open/in_progress/resolved)
- resolved_by: varchar → users.id
- resolved_at: timestamp
- created_at: timestamp

EQUIPMENT TABLE
---------------
Table: equipment
Purpose: Lab equipment tracking
Key Fields:
- id: varchar (UUID, Primary Key)
- company_id: varchar → companies.id
- test_room_id: varchar → test_rooms.id
- name: varchar
- manufacturer: varchar
- model: varchar
- serial_number: varchar
- status: equipment_status enum (operational/maintenance/repair/offline)
- purchase_date: timestamp
- last_calibration_date: timestamp
- next_calibration_date: timestamp
- calibration_frequency_days: integer
- last_maintenance: timestamp
- next_maintenance: timestamp
- specifications: jsonb
- notes: text
- location: varchar
- warranty_expiration: timestamp
- maintenance_history: jsonb
- metadata: jsonb
- created_at: timestamp
- updated_at: timestamp

QUALITY_ISSUES TABLE
--------------------
Table: quality_issues
Purpose: Quality control issue tracking
Key Fields:
- id: varchar (UUID, Primary Key)
- issue_type: quality_issue_type enum (surface_defect/coating_defect/measurement_error/material_defect/processing_error/other)
- order_id: varchar → orders.id
- description: text
- severity: integer
- detected_at: timestamp
- detected_by: varchar → users.id
- status: varchar (open/investigating/resolved/closed)
- resolution: text
- resolved_at: timestamp
- resolved_by: varchar → users.id
- root_cause: text
- preventive_actions: text
- metadata: jsonb

RETURNS TABLE
-------------
Table: returns
Purpose: Product return tracking
Key Fields:
- id: varchar (UUID, Primary Key)
- order_id: varchar → orders.id
- return_reason: varchar
- return_type: varchar
- description: text
- created_at: timestamp
- created_by: varchar → users.id
- status: varchar (pending/approved/rejected/completed)
- processing_notes: text
- replacement_order_id: varchar → orders.id
- quality_issue_id: varchar → quality_issues.id
- metadata: jsonb

NON_ADAPTS TABLE
----------------
Table: non_adapts
Purpose: Patient non-adaptation tracking
Key Fields:
- id: varchar (UUID, Primary Key)
- order_id: varchar → orders.id
- reported_by: varchar → users.id
- patient_feedback: text
- symptoms: jsonb (array of symptoms)
- created_at: timestamp
- resolution: text
- resolution_type: varchar
- resolved_at: timestamp
- quality_issue_id: varchar → quality_issues.id
- replacement_order_id: varchar → orders.id
- metadata: jsonb

3.5 ANALYTICS & TRACKING TABLES
--------------------------------

ANALYTICS_EVENTS TABLE
----------------------
Table: analytics_events
Purpose: System-wide event tracking
Key Fields:
- id: varchar (UUID, Primary Key)
- event_type: analytics_event_type enum (order_created/order_updated/quality_issue/equipment_status/material_usage/return_created/non_adapt_reported)
- timestamp: timestamp
- source_id: varchar
- source_type: varchar
- data: jsonb
- metadata: jsonb
- organization_id: varchar

ORDER_TIMELINE TABLE
--------------------
Table: order_timeline
Purpose: Order status history
Key Fields:
- id: varchar (UUID, Primary Key)
- order_id: varchar → orders.id
- status: varchar
- details: text
- timestamp: timestamp
- user_id: varchar → users.id
- metadata: jsonb

3.6 AI & INTELLIGENCE TABLES (Schema Exists)
---------------------------------------------

AI_CONVERSATIONS TABLE
----------------------
Table: ai_conversations
Purpose: AI assistant chat sessions
Key Fields:
- id: varchar (UUID, Primary Key)
- company_id: varchar → companies.id
- user_id: varchar → users.id
- title: varchar
- status: ai_conversation_status enum (active/archived)
- created_at: timestamp
- last_message_at: timestamp
- metadata: jsonb

AI_MESSAGES TABLE
-----------------
Table: ai_messages
Purpose: Individual AI chat messages
Key Fields:
- id: varchar (UUID, Primary Key)
- conversation_id: varchar → ai_conversations.id
- role: ai_message_role enum (user/assistant/system)
- content: text
- confidence_score: integer (0-100)
- sources: jsonb
- created_at: timestamp
- model_used: varchar
- metadata: jsonb

AI_KNOWLEDGE_BASE TABLE
-----------------------
Table: ai_knowledge_base
Purpose: Documents uploaded for AI learning
Key Fields:
- id: varchar (UUID, Primary Key)
- company_id: varchar → companies.id
- title: varchar
- content: text
- content_hash: varchar
- file_name: varchar
- file_type: varchar
- file_url: text
- embedding_vector: text
- tags: varchar[]
- created_by: varchar → users.id
- created_at: timestamp
- last_accessed: timestamp
- access_count: integer
- metadata: jsonb

AI_LEARNING_DATA TABLE
----------------------
Table: ai_learning_data
Purpose: Learned Q&A patterns
Key Fields:
- id: varchar (UUID, Primary Key)
- company_id: varchar → companies.id
- question_pattern: text
- answer: text
- confidence_score: integer
- usage_count: integer
- success_rate: integer
- context_tags: varchar[]
- created_at: timestamp
- last_used: timestamp
- source: varchar
- metadata: jsonb

AI_FEEDBACK TABLE
-----------------
Table: ai_feedback
Purpose: User feedback on AI responses
Key Fields:
- id: varchar (UUID, Primary Key)
- message_id: varchar → ai_messages.id
- user_id: varchar → users.id
- feedback_type: varchar (positive/negative/neutral)
- rating: integer (1-5)
- comment: text
- created_at: timestamp

3.7 NOTIFICATION & SETTINGS TABLES
-----------------------------------

NOTIFICATIONS TABLE
-------------------
Table: notifications
Purpose: User notifications
Key Fields:
- id: varchar (UUID, Primary Key)
- type: notification_type enum (info/warning/error/success)
- title: text
- message: text
- severity: notification_severity enum (low/medium/high)
- target: jsonb (user/role/organization)
- read: boolean
- read_at: timestamp
- created_at: timestamp

ORGANIZATION_SETTINGS TABLE
----------------------------
Table: organization_settings
Purpose: Company-level configuration
Key Fields:
- id: varchar (UUID, Primary Key)
- company_id: varchar → companies.id (unique)
- company_name: varchar
- contact_email: varchar
- contact_phone: varchar
- address: jsonb
- timezone: varchar
- currency: varchar
- date_format: varchar
- language: varchar
- logo_url: text
- theme_color: varchar
- updated_at: timestamp
- updated_by: varchar → users.id

USER_PREFERENCES TABLE
----------------------
Table: user_preferences
Purpose: User-level preferences
Key Fields:
- id: varchar (UUID, Primary Key)
- user_id: varchar → users.id (unique)
- theme: varchar (light/dark/system)
- language: varchar
- timezone: varchar
- notifications_enabled: boolean
- email_notifications: boolean
- dashboard_layout: jsonb
- updated_at: timestamp

3.8 SUBSCRIPTION & BILLING TABLES
----------------------------------

SUBSCRIPTION_PLANS TABLE
------------------------
Table: subscription_plans
Purpose: Available subscription plans
Key Fields:
- id: varchar (UUID, Primary Key)
- name: varchar
- description: text
- price: decimal(10,2)
- billing_period: varchar (monthly/annual)
- features: jsonb
- is_active: boolean
- stripe_price_id: varchar
- created_at: timestamp

STRIPE_PAYMENT_INTENTS TABLE
-----------------------------
Table: stripe_payment_intents
Purpose: Stripe payment tracking
Key Fields:
- id: varchar (UUID, Primary Key)
- company_id: varchar → companies.id
- user_id: varchar → users.id
- stripe_payment_intent_id: varchar
- amount: integer
- currency: varchar
- status: varchar
- metadata: jsonb
- created_at: timestamp

SUBSCRIPTION_HISTORY TABLE
---------------------------
Table: subscription_history
Purpose: Subscription change audit log
Key Fields:
- id: varchar (UUID, Primary Key)
- company_id: varchar → companies.id
- old_plan: subscription_plan enum
- new_plan: subscription_plan enum
- changed_by: varchar → users.id
- changed_at: timestamp
- reason: text
- metadata: jsonb

3.9 MULTI-TENANT RELATIONSHIP TABLES
-------------------------------------

COMPANY_SUPPLIER_RELATIONSHIPS TABLE
------------------------------------
Table: company_supplier_relationships
Purpose: ECP-Supplier partnerships
Key Fields:
- id: varchar (UUID, Primary Key)
- dispenser_company_id: varchar → companies.id
- supplier_company_id: varchar → companies.id
- status: varchar (pending/approved/rejected/suspended)
- requested_at: timestamp
- requested_by: varchar → users.id
- approved_at: timestamp
- approved_by: varchar → users.id
- notes: text
- metadata: jsonb

3.10 ADDITIONAL SPECIALIZED TABLES
-----------------------------------

DISPENSE_RECORDS TABLE
----------------------
Table: dispense_records
Purpose: GOC compliance dispensing records
Key Fields:
- id: varchar (UUID, Primary Key)
- company_id: varchar → companies.id
- patient_id: varchar → patients.id
- prescription_id: varchar → prescriptions.id
- dispense_date: timestamp
- dispenser_id: varchar → users.id
- goc_number: varchar
- product_type: varchar
- products_dispensed: jsonb
- patient_signature: text
- dispenser_signature: text
- aftercare_provided: boolean
- aftercare_notes: text
- created_at: timestamp

DICOM_READINGS TABLE
--------------------
Table: dicom_readings
Purpose: Medical imaging data from equipment
Key Fields:
- id: varchar (UUID, Primary Key)
- examination_id: varchar → eye_examinations.id
- study_instance_uid: varchar
- series_instance_uid: varchar
- image_instance_uid: varchar
- modality: varchar
- equipment_id: varchar → equipment.id
- manufacturer: varchar
- model_name: varchar
- measurements: jsonb
- raw_data: text
- created_at: timestamp

SESSIONS TABLE
--------------
Table: sessions
Purpose: Express session storage
Key Fields:
- sid: varchar (Primary Key)
- user_id: varchar → users.id
- sess: jsonb (session data)
- expire: timestamp

Indexes:
- idx_session_expire (expire)
- idx_session_user (user_id)

================================================================================
4. API ENDPOINTS REFERENCE
================================================================================

BASE URL: http://localhost:3000/api (development)

4.1 AUTHENTICATION ENDPOINTS
-----------------------------

POST /api/auth/login
Description: Email/password login
Request Body:
  {
    "email": "user@example.com",
    "password": "password123"
  }
Response: 200 OK with user object and session cookie

POST /api/auth/signup
Description: New user registration
Request Body:
  {
    "email": "user@example.com",
    "password": "password123",
    "firstName": "John",
    "lastName": "Doe",
    "organization": "Acme Optical",
    "role": "ecp"
  }
Response: 201 Created

POST /api/auth/logout
Description: End session
Response: 200 OK

GET /api/auth/user
Description: Get current authenticated user
Authentication: Required
Response: User object with roles

GET /api/auth/bootstrap
Description: Initial app load - returns user and redirect path
Authentication: Required
Response:
  {
    "user": { ... },
    "redirectPath": "/ecp/dashboard",
    "requiresSetup": false,
    "isPending": false
  }

GET /api/auth/available-roles
Description: Get all roles assigned to current user
Authentication: Required
Response: Array of role strings

POST /api/auth/switch-role
Description: Switch active role
Authentication: Required
Request Body:
  {
    "role": "lab_tech"
  }
Response: Updated user object

4.2 ORDER MANAGEMENT ENDPOINTS
-------------------------------

GET /api/orders
Description: List orders (filtered by role and company)
Authentication: Required
Query Parameters:
  - status: Filter by order status
  - patientId: Filter by patient
  - limit: Results per page
  - offset: Pagination offset
Response: Array of order objects

POST /api/orders
Description: Create new order
Authentication: Required
Request Body:
  {
    "patientId": "uuid",
    "prescription": { ... },
    "lensSpecifications": { ... },
    "frameSpecifications": { ... },
    "customerReference": "REF-123",
    "notes": "Special instructions"
  }
Response: 201 Created with order object

GET /api/orders/:id
Description: Get single order details
Authentication: Required
Response: Order object with patient and timeline

PATCH /api/orders/:id/status
Description: Update order status
Authentication: Required
Request Body:
  {
    "status": "in_production",
    "details": "Started lens cutting"
  }
Response: Updated order object

PATCH /api/orders/:id/oma
Description: Upload OMA file to order
Authentication: Required
Request: multipart/form-data with file
Response: Order with OMA data

GET /api/orders/:id/oma
Description: Get OMA data for order
Authentication: Required
Response: OMA file data object

DELETE /api/orders/:id/oma
Description: Remove OMA file from order
Authentication: Required
Response: 204 No Content

4.3 PATIENT MANAGEMENT ENDPOINTS
---------------------------------

GET /api/patients
Description: List patients (company-scoped)
Authentication: Required
Response: Array of patient objects

POST /api/patients
Description: Create new patient
Authentication: Required
Request Body:
  {
    "firstName": "John",
    "lastName": "Doe",
    "dateOfBirth": "1990-01-01",
    "email": "john@example.com",
    "phone": "555-0123",
    "address": { ... }
  }
Response: 201 Created with patient object (includes auto-generated customer_number)

GET /api/patients/:id
Description: Get patient details
Authentication: Required
Response: Patient object

PATCH /api/patients/:id
Description: Update patient
Authentication: Required
Request Body: Partial patient object
Response: Updated patient

DELETE /api/patients/:id
Description: Delete patient
Authentication: Required
Response: 204 No Content

4.4 SUPPLIER MANAGEMENT ENDPOINTS
----------------------------------

GET /api/suppliers
Description: List suppliers (company-scoped)
Authentication: Required
Response: Array of supplier objects

POST /api/suppliers
Description: Create new supplier
Authentication: Required
Request Body:
  {
    "name": "Lens Wholesale Inc",
    "contactName": "Jane Smith",
    "email": "jane@lensco.com",
    "phone": "555-9876",
    "address": { ... },
    "accountNumber": "ACC-12345"
  }
Response: 201 Created

GET /api/suppliers/:id
Description: Get supplier details
Authentication: Required
Response: Supplier object

PATCH /api/suppliers/:id
Description: Update supplier
Authentication: Required
Request Body: Partial supplier object
Response: Updated supplier

DELETE /api/suppliers/:id
Description: Delete supplier
Authentication: Required
Response: 204 No Content

4.5 PURCHASE ORDER ENDPOINTS
-----------------------------

POST /api/purchase-orders
Description: Create purchase order
Authentication: Required
Request Body:
  {
    "supplierId": "uuid",
    "poNumber": "PO-2025-001",
    "lineItems": [
      {
        "description": "1.67 High Index Lenses",
        "quantity": 20,
        "unitPrice": 45.00,
        "total": 900.00
      }
    ],
    "customerReference": "REF-123",
    "notes": "Rush order"
  }
Response: 201 Created with PO object

GET /api/purchase-orders
Description: List purchase orders (company-scoped)
Authentication: Required
Response: Array of PO objects

GET /api/purchase-orders/:id
Description: Get PO details
Authentication: Required
Response: PO object with line items

PATCH /api/purchase-orders/:id/status
Description: Update PO status
Authentication: Required
Request Body:
  {
    "status": "sent",
    "deliveryNotes": "Expected delivery in 3 days"
  }
Response: Updated PO

POST /api/purchase-orders/:id/email
Description: Email PO to supplier
Authentication: Required
Response: 200 OK

4.6 POS (POINT OF SALE) ENDPOINTS
----------------------------------

GET /api/pos/products
Description: List products (company-scoped)
Authentication: Required
Response: Array of product objects

POST /api/pos/products
Description: Create product
Authentication: Required
Request Body:
  {
    "sku": "FRAME-001",
    "name": "Designer Frame A",
    "description": "Premium titanium frame",
    "productType": "frame",
    "price": 199.99,
    "cost": 89.99,
    "stockQuantity": 15
  }
Response: 201 Created

PATCH /api/pos/products/:id
Description: Update product
Authentication: Required
Request Body: Partial product object
Response: Updated product

DELETE /api/pos/products/:id
Description: Delete product
Authentication: Required
Response: 204 No Content

GET /api/pos/invoices
Description: List invoices (company-scoped)
Authentication: Required
Response: Array of invoice objects

POST /api/pos/invoices
Description: Create invoice
Authentication: Required
Request Body:
  {
    "patientId": "uuid",
    "lineItems": [
      {
        "productId": "uuid",
        "description": "Designer Frame A",
        "quantity": 1,
        "unitPrice": 199.99,
        "total": 199.99
      }
    ],
    "paymentMethod": "card",
    "notes": ""
  }
Response: 201 Created

GET /api/pos/prescriptions
Description: List prescriptions (company-scoped)
Authentication: Required
Response: Array of prescription objects

POST /api/pos/prescriptions
Description: Create prescription
Authentication: Required
Request Body:
  {
    "patientId": "uuid",
    "prescriptionType": "spectacles",
    "prescriptionData": { ... },
    "expiryDate": "2026-11-02"
  }
Response: 201 Created

4.7 ADMIN ENDPOINTS
-------------------

GET /api/admin/users
Description: List all users (admin only)
Authentication: Required (admin role)
Response: Array of user objects

GET /api/admin/users/stats
Description: User statistics
Authentication: Required (admin role)
Response:
  {
    "totalUsers": 150,
    "activeUsers": 120,
    "pendingUsers": 15,
    "suspendedUsers": 5,
    "usersByRole": { ... }
  }

POST /api/admin/users/:id/approve
Description: Approve pending user
Authentication: Required (admin role)
Response: Updated user

POST /api/admin/users/:id/suspend
Description: Suspend user account
Authentication: Required (admin role)
Request Body:
  {
    "reason": "Policy violation"
  }
Response: Updated user

POST /api/admin/users/:id/activate
Description: Reactivate suspended user
Authentication: Required (admin role)
Response: Updated user

PATCH /api/admin/users/:id/role
Description: Change user role
Authentication: Required (admin role)
Request Body:
  {
    "role": "engineer"
  }
Response: Updated user

4.8 EYE EXAMINATION ENDPOINTS
------------------------------

GET /api/examinations
Description: List examinations (company-scoped)
Authentication: Required
Response: Array of examination objects

POST /api/examinations
Description: Create examination record
Authentication: Required
Request Body:
  {
    "patientId": "uuid",
    "examinationDate": "2025-11-02T10:00:00Z",
    "chiefComplaint": "Blurry vision",
    "visualAcuity": { ... },
    "refraction": { ... },
    "diagnosis": "Myopia",
    "plan": "Prescribe corrective lenses"
  }
Response: 201 Created

GET /api/examinations/:id
Description: Get examination details
Authentication: Required
Response: Examination object

PATCH /api/examinations/:id
Description: Update examination
Authentication: Required
Request Body: Partial examination object
Response: Updated examination

4.9 SETTINGS ENDPOINTS
----------------------

GET /api/settings/organization
Description: Get company settings
Authentication: Required
Response: Organization settings object

PATCH /api/settings/organization
Description: Update company settings
Authentication: Required
Request Body:
  {
    "companyName": "New Name",
    "contactEmail": "contact@example.com",
    "timezone": "America/New_York"
  }
Response: Updated settings

GET /api/settings/preferences
Description: Get user preferences
Authentication: Required
Response: User preferences object

PATCH /api/settings/preferences
Description: Update user preferences
Authentication: Required
Request Body:
  {
    "theme": "dark",
    "language": "en",
    "notificationsEnabled": true
  }
Response: Updated preferences

4.10 ANALYTICS ENDPOINTS (Limited Implementation)
-------------------------------------------------

GET /api/analytics/dashboard
Description: Dashboard metrics
Authentication: Required
Response: Analytics data

GET /api/alerts/prescriptions
Description: Get prescription alerts
Authentication: Required
Response: Array of alerts

POST /api/alerts/prescriptions/:id/dismiss
Description: Dismiss an alert
Authentication: Required
Response: 200 OK

GET /api/recommendations/bi
Description: Get BI recommendations
Authentication: Required
Response: Array of recommendations

POST /api/recommendations/bi/analyze
Description: Trigger analysis
Authentication: Required
Response: Analysis results

4.11 HEALTH CHECK
-----------------

GET /health
Description: Server health check
Authentication: Not required
Response:
  {
    "status": "healthy",
    "timestamp": "2025-11-02T12:00:00Z",
    "environment": "production"
  }

================================================================================
END OF PART 2
================================================================================
Next: PART 3 - Implementation Guide, Workflows & User Journeys
