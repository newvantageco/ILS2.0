================================================================================
INTEGRATED LENS SYSTEM (ILS) - PLATFORM OVERVIEW
PART 2: ADVANCED FEATURES, API REFERENCE & DATABASE
================================================================================
Generated: November 4, 2025
Repository: ILS2.0 (newvantageco)
Version: 1.0.0

================================================================================
TABLE OF CONTENTS - PART 2
================================================================================
1. Advanced Features (Partial/Planned)
2. Multi-Tenant Architecture
3. Subscription & Billing System
4. Complete API Reference
5. Database Schema Overview
6. Key Database Tables
7. Services Architecture

================================================================================
1. ADVANCED FEATURES (PARTIAL/PLANNED)
================================================================================

1.1 SUPPLIER MANAGEMENT & PURCHASE ORDERS ✅ 90% COMPLETE
────────────────────────────────────────────────────────────────────────────

FEATURES:
✅ Supplier CRUD operations
✅ Supplier profiles (contact info, addresses, account numbers)
✅ Purchase order creation with line items
✅ PO status tracking (draft → sent → delivered)
✅ PDF generation for purchase orders
✅ Email notifications to suppliers
✅ Technical document uploads per supplier
✅ Supplier relationship management

PO STATUS WORKFLOW:
1. draft          → Initial creation
2. sent           → Emailed to supplier
3. acknowledged   → Supplier confirms receipt
4. in_transit     → Goods being shipped
5. delivered      → Items received
6. cancelled      → Order cancelled

API ENDPOINTS:
GET    /api/suppliers              - List suppliers (company-scoped)
POST   /api/suppliers              - Create supplier
GET    /api/suppliers/:id          - Get supplier details
PATCH  /api/suppliers/:id          - Update supplier
DELETE /api/suppliers/:id          - Delete supplier
POST   /api/purchase-orders        - Create PO
GET    /api/purchase-orders        - List POs
GET    /api/purchase-orders/:id    - Get PO details
PATCH  /api/purchase-orders/:id/status - Update PO status
GET    /api/technical-documents    - List tech docs
POST   /api/technical-documents    - Upload document

DATABASE TABLES:
- suppliers (vendor information)
- purchase_orders (PO headers)
- po_line_items (PO detail lines)
- technical_documents (supplier docs)

1.2 EYE EXAMINATION SYSTEM ✅ 80% COMPLETE
────────────────────────────────────────────────────────────────────────────

DESCRIPTION:
Comprehensive eye examination recording with 10-tab interface covering all
aspects of optometric examination.

EXAMINATION TABS:
1. Patient History
   - Chief complaint
   - Medical history
   - Ocular history
   - Family history
   - Current medications
   - Allergies

2. Visual Acuity
   - Distance VA (OD, OS, OU)
   - Near VA (OD, OS, OU)
   - With/without correction
   - Pinhole acuity

3. Refraction
   - Objective refraction (retinoscopy/autorefractor)
   - Subjective refraction
   - Sphere, Cylinder, Axis, Add
   - Visual acuity achieved

4. Binocular Vision
   - Cover test (distance/near)
   - Ocular motility
   - Convergence
   - Stereopsis
   - Accommodation
   - Fusional reserves

5. Anterior Eye
   - Lids and lashes
   - Conjunctiva
   - Cornea
   - Anterior chamber
   - Iris
   - Lens
   - Slit lamp findings

6. Intraocular Pressure (IOP)
   - Method (Goldman, NCT, iCare)
   - OD measurement
   - OS measurement
   - Time of measurement

7. Posterior Eye (Fundus)
   - Optic disc appearance
   - Cup-to-disc ratio
   - Macula examination
   - Peripheral retina
   - Vessels
   - Vitreous

8. Additional Tests
   - Visual fields
   - Color vision
   - Contrast sensitivity
   - Pupil reactions
   - OCT imaging
   - Fundus photography

9. Diagnosis & Management
   - Primary diagnosis
   - Secondary diagnoses
   - Management plan
   - Medications prescribed
   - Follow-up recommendations

10. Clinical Notes
    - Additional observations
    - Patient instructions
    - Referral notes
    - Practitioner signature

FEATURES:
✅ Multi-tab form interface
✅ Auto-save functionality
✅ Finalization workflow
✅ PDF generation of examination reports
✅ Patient association
✅ Historical examination tracking
✅ Template-based data entry
✅ DICOM integration support (planned)

API ENDPOINTS:
GET    /api/ecp/examinations           - List examinations
POST   /api/ecp/examinations           - Create examination
GET    /api/ecp/examinations/:id       - Get examination
PATCH  /api/ecp/examinations/:id       - Update examination
POST   /api/ecp/examinations/:id/finalize - Finalize examination
GET    /api/ecp/examinations/:id/pdf   - Generate PDF report

DATABASE TABLE:
- eye_examinations (JSONB storage for flexible data structure)

1.3 TEST ROOM BOOKING SYSTEM ✅ 75% COMPLETE
────────────────────────────────────────────────────────────────────────────

DESCRIPTION:
Manage test rooms and appointment bookings for eye examinations.

FEATURES:
✅ Test room CRUD operations
✅ Room capacity management
✅ Equipment assignment to rooms
✅ Booking creation and management
✅ Time slot management
✅ Booking status (scheduled, completed, cancelled, no-show)
✅ Patient association
✅ Practitioner assignment
✅ Calendar view (planned)

API ENDPOINTS:
GET    /api/ecp/test-rooms             - List test rooms
POST   /api/ecp/test-rooms             - Create test room
GET    /api/ecp/test-rooms/:id         - Get test room
PATCH  /api/ecp/test-rooms/:id         - Update test room
DELETE /api/ecp/test-rooms/:id         - Delete test room
GET    /api/ecp/bookings               - List bookings
POST   /api/ecp/bookings               - Create booking
PATCH  /api/ecp/bookings/:id           - Update booking
PATCH  /api/ecp/bookings/:id/status    - Update booking status

DATABASE TABLES:
- test_rooms (room definitions)
- test_room_bookings (appointment slots)

1.4 ANALYTICS & BUSINESS INTELLIGENCE ⚠️ 40% COMPLETE
────────────────────────────────────────────────────────────────────────────

DESCRIPTION:
Basic analytics dashboard with key metrics and reporting.

CURRENT FEATURES:
✅ Order statistics
✅ Revenue tracking
✅ Production metrics
✅ User activity logs
✅ Basic charts and graphs

PLANNED FEATURES (NOT YET FUNCTIONAL):
❌ Predictive analytics
❌ Advanced forecasting
❌ AI-powered insights
❌ Anomaly detection
❌ Demand forecasting
❌ Staffing recommendations
❌ Bottleneck identification

API ENDPOINTS (BASIC):
GET    /api/analytics/dashboard        - Dashboard overview
GET    /api/analytics/orders           - Order analytics
GET    /api/analytics/revenue          - Revenue reports
GET    /api/metrics/dashboard          - Metrics dashboard
GET    /api/metrics/production         - Production metrics

NOTE: Many documented AI analytics features are not yet integrated.

1.5 EQUIPMENT MANAGEMENT ⚠️ 20% COMPLETE
────────────────────────────────────────────────────────────────────────────

DESCRIPTION:
Track optical equipment, calibration, and maintenance schedules.

DATABASE SCHEMA EXISTS:
✅ equipment table created
✅ Calibration tracking fields
✅ Maintenance history (JSONB)
✅ Status tracking (operational, maintenance, repair, offline)

CURRENT STATUS:
⚠️ Database table exists
⚠️ No API endpoints implemented
⚠️ No frontend interface
⚠️ Planned feature for future release

PLANNED FEATURES:
❌ Equipment list and details
❌ Calibration scheduling
❌ Maintenance logging
❌ Equipment alerts (calibration due)
❌ Usage tracking
❌ Cost tracking

1.6 AI ASSISTANT ⚠️ 5% COMPLETE (NON-FUNCTIONAL)
────────────────────────────────────────────────────────────────────────────

DESCRIPTION:
AI-powered chat assistant for optical industry queries with progressive
learning capabilities.

DOCUMENTATION CLAIMS:
- "100% Complete AI Implementation"
- "Progressive learning reduces external API costs"
- "Neural network training"
- "Company-specific knowledge base"
- "Multi-provider support (Ollama, OpenAI, Anthropic)"

ACTUAL STATUS (AUDIT FINDINGS):
❌ Frontend exists (AIAssistantPage.tsx)
❌ Services written but not connected:
   - AIAssistantService.ts (700+ lines of code)
   - ExternalAIService.ts (AI provider integration)
   - NeuralNetworkService.ts (learning system)
   - ProprietaryAIService.ts (custom AI logic)
❌ NO API routes in server/routes.ts
❌ Database tables created but unused:
   - ai_conversations
   - ai_messages
   - ai_knowledge_base
   - ai_learning_data
❌ Frontend would receive 404 errors

VERDICT: Aspirational feature, not production-ready

REQUIRED TO ACTIVATE:
1. Register routes in server/index.ts or routes.ts
2. Connect services to route handlers
3. Test AI provider integration
4. Configure API keys
5. Implement learning pipeline
6. Test knowledge base uploads

POTENTIAL (IF COMPLETED):
- Natural language optical queries
- Progressive learning (reduces API costs over time)
- Company-specific knowledge bases
- Multi-provider fallback (cost optimization)
- Local AI option (Ollama for privacy)

1.7 RETURNS & NON-ADAPTS ✅ 85% COMPLETE
────────────────────────────────────────────────────────────────────────────

DESCRIPTION:
Manage product returns and patient non-adapt cases (patients who cannot
adapt to new lenses).

FEATURES:
✅ Create return requests
✅ Link returns to orders
✅ Return reason tracking
✅ Return type classification
✅ Processing notes
✅ Replacement order linking
✅ Quality issue association
✅ Non-adapt symptom tracking
✅ Patient feedback recording
✅ Resolution tracking

RETURN TYPES:
- warranty_defect    - Manufacturing defect
- measurement_error  - Incorrect prescription
- patient_discomfort - Comfort issues
- damaged_in_transit - Shipping damage
- wrong_product     - Order fulfillment error
- patient_request   - Customer satisfaction

API ENDPOINTS:
GET    /api/returns                    - List returns
POST   /api/returns                    - Create return
GET    /api/returns/:id                - Get return details
PATCH  /api/returns/:id/status         - Update return status
GET    /api/non-adapts                 - List non-adapt cases
POST   /api/non-adapts                 - Report non-adapt
PATCH  /api/non-adapts/:id             - Update non-adapt

DATABASE TABLES:
- returns (return requests)
- non_adapts (non-adaptation cases)
- quality_issues (linked QC problems)

1.8 EMAIL SYSTEM ✅ 90% COMPLETE
────────────────────────────────────────────────────────────────────────────

DESCRIPTION:
Comprehensive email notification system with delivery tracking.

FEATURES:
✅ Transactional emails (Resend API)
✅ Order confirmation emails
✅ Status update notifications
✅ Invoice delivery
✅ Purchase order emails to suppliers
✅ Email tracking (sent, delivered, opened, clicked)
✅ Template-based emails
✅ Batch email sending
✅ Email event webhooks

EMAIL TYPES:
- invoice                - Invoice delivery
- receipt                - Payment receipts
- order_confirmation     - Order placed notifications
- order_update           - Status change updates
- prescription_reminder  - Prescription expiry alerts
- recall_notification    - Product recalls
- appointment_reminder   - Booking reminders
- marketing             - Promotional emails
- general               - Other communications

EMAIL TRACKING EVENTS:
- sent       - Email dispatched
- delivered  - Successfully delivered
- opened     - Recipient opened email
- clicked    - Links clicked
- bounced    - Delivery failed
- spam       - Marked as spam

API ENDPOINTS:
POST   /api/emails/send                - Send email
GET    /api/emails/tracking/:id        - Get email tracking
GET    /api/emails/analytics           - Email analytics
POST   /api/emails/webhook             - Resend webhook handler

DATABASE TABLES:
- email_tracking (delivery status)
- email_events (event log)
- scheduled_emails (planned sends)

SERVICE:
- EmailService.ts (Resend integration)
- OrderEmailService.ts (order-specific emails)
- ScheduledEmailService.ts (scheduling)

1.9 PDF GENERATION ✅ 90% COMPLETE
────────────────────────────────────────────────────────────────────────────

DESCRIPTION:
Professional PDF document generation for various business documents.

SUPPORTED DOCUMENTS:
✅ Invoices (branded, itemized)
✅ Purchase Orders (supplier format)
✅ Lab Work Tickets (production instructions)
✅ Examination Reports (clinical findings)
✅ Receipts (payment confirmation)
✅ Prescription Slips (dispensing)
✅ Dispense Slips (GOC compliant)

FEATURES:
✅ Company branding (logos, colors)
✅ Professional formatting
✅ QR codes (for tracking)
✅ Multi-page support
✅ Tables and line items
✅ Headers and footers
✅ Digital signatures (planned)

PDF SERVICES:
- PDFService.ts (basic PDF generation)
- ProfessionalPDFService.ts (enhanced styling)
- AdvancedPDFService.ts (complex documents)
- LabWorkTicketService.ts (production tickets)

LIBRARIES:
- pdfkit (PDF creation)
- qrcode (QR code generation)

API ENDPOINTS:
GET    /api/pdf/invoice/:id            - Generate invoice PDF
GET    /api/pdf/purchase-order/:id     - Generate PO PDF
GET    /api/pdf/work-ticket/:id        - Generate work ticket
GET    /api/pdf/examination/:id        - Generate exam report

================================================================================
2. MULTI-TENANT ARCHITECTURE
================================================================================

DESCRIPTION:
Complete data isolation between companies/organizations with relationship
management for inter-company interactions (ECP ↔ Lab ↔ Supplier).

ARCHITECTURE:
┌─────────────────────────────────────────────────────────────────────────┐
│                         MULTI-TENANT STRUCTURE                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  Company A (ECP Practice)                                               │
│  ├─ Users (staff members)                                               │
│  ├─ Patients (customer records)                                         │
│  ├─ Orders (submitted to labs)                                          │
│  ├─ Invoices (sales transactions)                                       │
│  ├─ Products (inventory)                                                │
│  └─ Settings (practice preferences)                                     │
│                                                                          │
│  Company B (Lab Facility)                                               │
│  ├─ Users (technicians, engineers)                                      │
│  ├─ Orders (from ECPs)                                                  │
│  ├─ Equipment (production machines)                                     │
│  ├─ Purchase Orders (to suppliers)                                      │
│  └─ Settings (lab configuration)                                        │
│                                                                          │
│  Company C (Supplier)                                                   │
│  ├─ Users (sales reps)                                                  │
│  ├─ Products (catalog)                                                  │
│  ├─ Purchase Orders (from labs)                                         │
│  └─ Technical Documents                                                 │
│                                                                          │
│  Relationships:                                                         │
│  • Company A submits orders to Company B                                │
│  • Company B creates POs for Company C                                  │
│  • Data isolated by company_id                                          │
│  • Cross-company visibility via relationships table                     │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘

COMPANY TYPES:
- ecp      - Eye Care Professional practice
- lab      - Lens manufacturing facility
- supplier - Material/equipment vendor
- hybrid   - Multiple capabilities

COMPANY STATUS:
- pending_approval - Awaiting platform admin approval
- active          - Fully operational
- suspended       - Temporarily disabled
- deactivated     - Permanently closed

DATA ISOLATION:
Every table with multi-tenant data includes company_id:
- users (belongs to company)
- patients (belongs to ECP company)
- orders (belongs to creating company)
- products (belongs to company)
- invoices (belongs to company)
- suppliers (belongs to company)
- equipment (belongs to company)

QUERY SCOPING:
All queries automatically filtered by company_id from user session:

```sql
-- Example: Get orders for logged-in user's company
SELECT * FROM orders 
WHERE company_id = :user_company_id
ORDER BY created_at DESC;
```

RELATIONSHIP MANAGEMENT:
company_relationships table links companies:
- ecp_company_id (ECP practice)
- related_company_id (Lab or Supplier)
- relationship_type (dispenser_to_lab, lab_to_supplier)
- status (active, pending, suspended)
- settings (relationship preferences)

API ENDPOINTS:
GET    /api/companies/:id              - Get company details
PATCH  /api/companies/:id              - Update company
GET    /api/companies/relationships/suppliers - List supplier relationships
GET    /api/companies/relationships/dispensers - List dispenser relationships
POST   /api/companies/relationships    - Create relationship
PATCH  /api/companies/relationships/:id - Update relationship

SECURITY:
✅ Automatic company_id injection from session
✅ Cross-tenant access blocked (403 Forbidden)
✅ Relationship-based visibility (orders visible to related companies)
✅ Platform admins can view all companies
✅ Company admins can only manage their company

SETUP REQUIREMENTS:
1. Company must be created (via signup or admin)
2. Company must be approved by platform admin
3. Users assigned to company during signup
4. Relationships configured for inter-company workflows
5. Subscription plan assigned

================================================================================
3. SUBSCRIPTION & BILLING SYSTEM
================================================================================

STRIPE INTEGRATION:
┌─────────────────────────────────────────────────────────────────────────┐
│                        SUBSCRIPTION LIFECYCLE                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  1. Company Registration                                                │
│     └─ Company created with subscription_plan = 'free_ecp'             │
│                                                                          │
│  2. Stripe Customer Creation                                            │
│     └─ POST /api/payments/create-customer                              │
│     └─ Stores stripe_customer_id in companies table                    │
│                                                                          │
│  3. Subscription Selection                                              │
│     └─ User selects plan (free_ecp or full)                            │
│     └─ For paid plans: Stripe Checkout session created                 │
│                                                                          │
│  4. Payment & Subscription Creation                                     │
│     └─ Stripe processes payment                                        │
│     └─ Subscription created in Stripe                                  │
│     └─ Webhook event: customer.subscription.created                    │
│                                                                          │
│  5. Database Update                                                     │
│     └─ stripe_subscription_id saved                                    │
│     └─ stripe_subscription_status = 'active'                           │
│     └─ stripe_current_period_end set                                   │
│     └─ subscription_plan updated                                       │
│                                                                          │
│  6. Feature Access Granted                                              │
│     └─ Middleware checks subscription status                           │
│     └─ denyFreePlanAccess() bypassed for paid users                    │
│     └─ All features unlocked                                           │
│                                                                          │
│  7. Ongoing Management                                                  │
│     └─ Webhooks handle renewals, cancellations, failures               │
│     └─ Automatic status updates in database                            │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘

SUBSCRIPTION PLANS:
┌─────────────────────────────────────────────────────────────────────────┐
│ Plan ID       │ Name              │ Price           │ Features         │
├───────────────┼───────────────────┼─────────────────┼──────────────────┤
│ free_ecp      │ Free ECP          │ £0/month        │ Limited          │
│ full          │ Full Experience   │ TBD             │ All Features     │
└─────────────────────────────────────────────────────────────────────────┘

DATABASE FIELDS (companies table):
- subscription_plan            - Current plan (enum)
- subscription_start_date      - When subscription began
- subscription_end_date        - When subscription expires
- billing_email                - Billing contact
- stripe_customer_id          - Stripe customer ID
- stripe_subscription_id      - Stripe subscription ID
- stripe_subscription_status  - active/canceled/past_due/trialing
- stripe_current_period_end   - Next billing date
- free_trial_end_date         - Trial expiration
- subscription_cancelled_at   - Cancellation timestamp
- is_subscription_exempt      - Admin override (bypass billing)

STRIPE WEBHOOKS:
✅ customer.subscription.created     - New subscription
✅ customer.subscription.updated     - Plan change
✅ customer.subscription.deleted     - Cancellation
✅ invoice.payment_succeeded         - Payment received
✅ invoice.payment_failed            - Payment failed
✅ customer.subscription.trial_will_end - Trial ending soon

WEBHOOK ENDPOINT:
POST /api/payments/webhook           - Stripe webhook handler

FEATURE GATING:
Middleware function checks subscription:

```typescript
function denyFreePlanAccess(req: any, res: any, next: any) {
  const company = req.user?.company;
  
  if (!company) {
    return res.status(403).json({ error: "No company found" });
  }
  
  // Exempt admin-created accounts
  if (company.is_subscription_exempt) {
    return next();
  }
  
  // Allow full plan subscribers
  if (company.subscription_plan === 'full') {
    return next();
  }
  
  // Check Stripe subscription status
  if (company.stripe_subscription_status === 'active') {
    return next();
  }
  
  // Block free plan users
  return res.status(403).json({ 
    error: "This feature requires a paid subscription",
    upgrade_url: "/settings/subscription" 
  });
}
```

PAYMENT PROCESSING:
- Stripe Checkout for initial subscription
- Automatic renewal via Stripe subscriptions
- Payment history in stripe_payment_intents table
- Support for multiple currencies (default: GBP)

API ENDPOINTS:
POST   /api/payments/create-customer     - Create Stripe customer
POST   /api/payments/create-checkout     - Start subscription checkout
POST   /api/payments/create-portal       - Customer portal access
POST   /api/payments/webhook             - Stripe webhook handler
GET    /api/payments/subscription-status - Get subscription status

SUBSCRIPTION MANAGEMENT:
- Users can upgrade/downgrade via settings
- Cancellation with immediate or end-of-period effect
- Pro-rated billing for plan changes
- Trial periods supported
- Grace periods for failed payments

================================================================================
4. COMPLETE API REFERENCE
================================================================================

BASE URL: http://localhost:3000/api

AUTHENTICATION: Session-based (Cookie)
AUTHORIZATION: Role-based + Company scoping

API CATEGORIES:
1. Authentication
2. Orders
3. Patients
4. Point of Sale
5. Suppliers & Purchase Orders
6. ECP Features
7. Lab Features
8. Admin
9. Companies (Multi-tenant)
10. Analytics
11. Payments
12. Email
13. PDF Generation

─────────────────────────────────────────────────────────────────────────────
4.1 AUTHENTICATION APIs
─────────────────────────────────────────────────────────────────────────────

POST   /api/auth/signup
Description: Register new user account
Body: { email, password, firstName, lastName, organization, requestedRoles }
Response: { user, message }
Status: 201 Created

POST   /api/auth/login
Description: Email/password login
Body: { email, password }
Response: { user, roles }
Status: 200 OK

POST   /api/auth/logout
Description: Logout and destroy session
Response: { message: "Logged out successfully" }
Status: 200 OK

GET    /api/auth/user
Description: Get current authenticated user
Response: { user, activeRole, availableRoles }
Status: 200 OK

GET    /api/auth/bootstrap
Description: Initial app load with user data
Response: { user, company, roles, settings }
Status: 200 OK

GET    /api/auth/available-roles
Description: Get user's assigned roles
Response: { roles: ['ecp', 'admin'] }
Status: 200 OK

POST   /api/auth/switch-role
Description: Switch active role
Body: { role: 'ecp' }
Response: { success: true, activeRole: 'ecp' }
Status: 200 OK

─────────────────────────────────────────────────────────────────────────────
4.2 ORDER APIs
─────────────────────────────────────────────────────────────────────────────

GET    /api/orders
Description: List all orders (company-scoped)
Query: ?status=pending&limit=50&offset=0
Response: { orders: [...], total: 150 }
Status: 200 OK

POST   /api/orders
Description: Create new order
Body: { patientId, prescription, lensSpecs, frameInfo, customerReference }
Response: { order }
Status: 201 Created

GET    /api/orders/:id
Description: Get order details with timeline
Response: { order, timeline, patient }
Status: 200 OK

PATCH  /api/orders/:id/status
Description: Update order status
Body: { status: 'in_production', notes: 'Started production' }
Response: { order }
Status: 200 OK
Permissions: lab_tech, engineer, admin

PATCH  /api/orders/:id/oma
Description: Upload OMA file to order
Body: FormData with 'oma_file'
Response: { order, omaData }
Status: 200 OK

GET    /api/orders/:id/oma
Description: Get parsed OMA data
Response: { omaData }
Status: 200 OK

DELETE /api/orders/:id/oma
Description: Remove OMA file from order
Response: { success: true }
Status: 200 OK

─────────────────────────────────────────────────────────────────────────────
4.3 PATIENT APIs
─────────────────────────────────────────────────────────────────────────────

GET    /api/patients
Description: List patients (company-scoped)
Query: ?search=john&limit=50
Response: { patients: [...], total: 200 }
Status: 200 OK

POST   /api/patients
Description: Create new patient (auto-generates customer number)
Body: { firstName, lastName, dateOfBirth, email, phone, address }
Response: { patient }
Status: 201 Created

GET    /api/patients/:id
Description: Get patient details
Response: { patient, orders: [...], examinations: [...] }
Status: 200 OK

PATCH  /api/patients/:id
Description: Update patient information
Body: { email, phone, address }
Response: { patient }
Status: 200 OK

DELETE /api/patients/:id
Description: Delete patient (soft delete)
Response: { success: true }
Status: 200 OK

─────────────────────────────────────────────────────────────────────────────
4.4 POINT OF SALE APIs
─────────────────────────────────────────────────────────────────────────────

GET    /api/pos/products
Description: List products (company inventory)
Query: ?category=frames&inStock=true
Response: { products: [...] }
Status: 200 OK

POST   /api/pos/products
Description: Create product
Body: { name, sku, price, category, stock }
Response: { product }
Status: 201 Created

PATCH  /api/pos/products/:id
Description: Update product
Body: { price, stock }
Response: { product }
Status: 200 OK

DELETE /api/pos/products/:id
Description: Delete product
Response: { success: true }
Status: 200 OK

GET    /api/pos/invoices
Description: List invoices
Query: ?status=paid&startDate=2025-01-01
Response: { invoices: [...] }
Status: 200 OK

POST   /api/pos/invoices
Description: Create invoice
Body: { patientId, lineItems, paymentMethod, amountPaid }
Response: { invoice }
Status: 201 Created

GET    /api/pos/prescriptions
Description: List prescriptions
Response: { prescriptions: [...] }
Status: 200 OK

POST   /api/pos/prescriptions
Description: Create prescription
Body: { patientId, odSphere, odCylinder, osSphere, expiryDate }
Response: { prescription }
Status: 201 Created

─────────────────────────────────────────────────────────────────────────────
4.5 SUPPLIER & PURCHASE ORDER APIs
─────────────────────────────────────────────────────────────────────────────

GET    /api/suppliers
Description: List suppliers (company-scoped)
Response: { suppliers: [...] }
Status: 200 OK

POST   /api/suppliers
Description: Create supplier
Body: { name, email, phone, address, accountNumber }
Response: { supplier }
Status: 201 Created

GET    /api/suppliers/:id
Description: Get supplier details
Response: { supplier, purchaseOrders: [...] }
Status: 200 OK

PATCH  /api/suppliers/:id
Description: Update supplier
Body: { phone, email, address }
Response: { supplier }
Status: 200 OK

DELETE /api/suppliers/:id
Description: Delete supplier
Response: { success: true }
Status: 200 OK

GET    /api/purchase-orders
Description: List purchase orders
Query: ?status=sent&supplierId=xxx
Response: { purchaseOrders: [...] }
Status: 200 OK

POST   /api/purchase-orders
Description: Create purchase order
Body: { supplierId, lineItems, deliveryDate, customerReference }
Response: { purchaseOrder }
Status: 201 Created

GET    /api/purchase-orders/:id
Description: Get PO details
Response: { purchaseOrder, lineItems, supplier }
Status: 200 OK

PATCH  /api/purchase-orders/:id/status
Description: Update PO status
Body: { status: 'delivered', notes: 'All items received' }
Response: { purchaseOrder }
Status: 200 OK

GET    /api/technical-documents
Description: List technical documents
Query: ?supplierId=xxx
Response: { documents: [...] }
Status: 200 OK

POST   /api/technical-documents
Description: Upload technical document
Body: FormData with 'document_file', supplierId, documentType
Response: { document }
Status: 201 Created

─────────────────────────────────────────────────────────────────────────────
4.6 ECP FEATURE APIs (Extended)
─────────────────────────────────────────────────────────────────────────────

GET    /api/ecp/examinations
Description: List eye examinations
Response: { examinations: [...] }
Status: 200 OK

POST   /api/ecp/examinations
Description: Create examination
Body: { patientId, examinationData }
Response: { examination }
Status: 201 Created

GET    /api/ecp/examinations/:id
Description: Get examination details
Response: { examination, patient }
Status: 200 OK

PATCH  /api/ecp/examinations/:id
Description: Update examination (auto-save)
Body: { examinationData }
Response: { examination }
Status: 200 OK

POST   /api/ecp/examinations/:id/finalize
Description: Finalize examination (lock)
Response: { examination }
Status: 200 OK

GET    /api/ecp/examinations/:id/pdf
Description: Generate examination report PDF
Response: PDF file (application/pdf)
Status: 200 OK

GET    /api/ecp/test-rooms
Description: List test rooms
Response: { testRooms: [...] }
Status: 200 OK

POST   /api/ecp/test-rooms
Description: Create test room
Body: { name, capacity, equipment }
Response: { testRoom }
Status: 201 Created

GET    /api/ecp/bookings
Description: List bookings
Query: ?date=2025-11-04&testRoomId=xxx
Response: { bookings: [...] }
Status: 200 OK

POST   /api/ecp/bookings
Description: Create booking
Body: { testRoomId, patientId, startTime, endTime, practitionerId }
Response: { booking }
Status: 201 Created

─────────────────────────────────────────────────────────────────────────────
4.7 LAB FEATURE APIs
─────────────────────────────────────────────────────────────────────────────

GET    /api/lab/queue
Description: Get production queue
Query: ?status=pending&priority=high
Response: { orders: [...], stats }
Status: 200 OK
Permissions: lab_tech, engineer

PATCH  /api/lab/orders/:id/assign
Description: Assign order to technician
Body: { technicianId }
Response: { order }
Status: 200 OK

POST   /api/lab/orders/:id/notes
Description: Add production notes
Body: { note: 'Complex prescription, extra care needed' }
Response: { note }
Status: 201 Created

GET    /api/lab/work-tickets/:id
Description: Get work ticket PDF
Response: PDF file
Status: 200 OK

─────────────────────────────────────────────────────────────────────────────
4.8 ADMIN APIs
─────────────────────────────────────────────────────────────────────────────

GET    /api/admin/users
Description: List all users
Query: ?status=pending&role=ecp
Response: { users: [...], total: 500 }
Status: 200 OK
Permissions: admin, platform_admin

GET    /api/admin/users/stats
Description: Get user statistics
Response: { total, active, pending, suspended, byRole }
Status: 200 OK

POST   /api/admin/users/:id/approve
Description: Approve pending user
Response: { user }
Status: 200 OK

POST   /api/admin/users/:id/suspend
Description: Suspend user account
Body: { reason: 'Policy violation' }
Response: { user }
Status: 200 OK

POST   /api/admin/users/:id/activate
Description: Reactivate suspended user
Response: { user }
Status: 200 OK

PATCH  /api/admin/users/:id/role
Description: Change user role
Body: { role: 'engineer' }
Response: { user }
Status: 200 OK

─────────────────────────────────────────────────────────────────────────────
4.9 COMPANY APIs (Multi-tenant)
─────────────────────────────────────────────────────────────────────────────

GET    /api/companies/:id
Description: Get company details
Response: { company }
Status: 200 OK

PATCH  /api/companies/:id
Description: Update company settings
Body: { name, email, phone, settings, brandingSettings }
Response: { company }
Status: 200 OK

GET    /api/companies/relationships/suppliers
Description: List supplier relationships
Response: { relationships: [...] }
Status: 200 OK

GET    /api/companies/relationships/dispensers
Description: List dispenser relationships
Response: { relationships: [...] }
Status: 200 OK

POST   /api/companies/relationships
Description: Create company relationship
Body: { relatedCompanyId, relationshipType, settings }
Response: { relationship }
Status: 201 Created

PATCH  /api/companies/relationships/:id
Description: Update relationship
Body: { status, settings }
Response: { relationship }
Status: 200 OK

─────────────────────────────────────────────────────────────────────────────
4.10 ANALYTICS APIs
─────────────────────────────────────────────────────────────────────────────

GET    /api/analytics/dashboard
Description: Get analytics dashboard overview
Response: { orderStats, revenueStats, productionStats }
Status: 200 OK

GET    /api/analytics/orders
Description: Order analytics
Query: ?startDate=2025-01-01&endDate=2025-12-31
Response: { totalOrders, avgOrderValue, ordersByStatus }
Status: 200 OK

GET    /api/analytics/revenue
Description: Revenue reports
Response: { totalRevenue, revenueByMonth, topProducts }
Status: 200 OK

GET    /api/metrics/dashboard
Description: Real-time metrics
Response: { activeOrders, completionRate, avgProcessingTime }
Status: 200 OK

─────────────────────────────────────────────────────────────────────────────
4.11 PAYMENT APIs (Stripe)
─────────────────────────────────────────────────────────────────────────────

POST   /api/payments/create-customer
Description: Create Stripe customer
Body: { companyId }
Response: { stripeCustomerId }
Status: 201 Created

POST   /api/payments/create-checkout
Description: Create Stripe Checkout session
Body: { planId, billingInterval: 'monthly' }
Response: { sessionId, checkoutUrl }
Status: 200 OK

POST   /api/payments/create-portal
Description: Get customer portal URL
Response: { portalUrl }
Status: 200 OK

POST   /api/payments/webhook
Description: Stripe webhook handler (internal)
Body: Stripe event payload
Status: 200 OK

GET    /api/payments/subscription-status
Description: Get subscription status
Response: { plan, status, currentPeriodEnd, features }
Status: 200 OK

─────────────────────────────────────────────────────────────────────────────
4.12 EMAIL APIs
─────────────────────────────────────────────────────────────────────────────

POST   /api/emails/send
Description: Send email
Body: { to, subject, body, type, metadata }
Response: { emailId, status }
Status: 200 OK

GET    /api/emails/tracking/:id
Description: Get email tracking info
Response: { sent, delivered, opened, clicked, events }
Status: 200 OK

GET    /api/emails/analytics
Description: Email analytics
Query: ?startDate=2025-01-01
Response: { totalSent, deliveryRate, openRate, clickRate }
Status: 200 OK

POST   /api/emails/webhook
Description: Resend webhook handler (internal)
Status: 200 OK

─────────────────────────────────────────────────────────────────────────────
4.13 PDF GENERATION APIs
─────────────────────────────────────────────────────────────────────────────

GET    /api/pdf/invoice/:id
Description: Generate invoice PDF
Response: PDF file (application/pdf)
Status: 200 OK

GET    /api/pdf/purchase-order/:id
Description: Generate purchase order PDF
Response: PDF file
Status: 200 OK

GET    /api/pdf/work-ticket/:id
Description: Generate lab work ticket PDF
Response: PDF file
Status: 200 OK

GET    /api/pdf/examination/:id
Description: Generate examination report PDF
Response: PDF file
Status: 200 OK

GET    /api/pdf/receipt/:id
Description: Generate payment receipt PDF
Response: PDF file
Status: 200 OK

GET    /api/pdf/prescription/:id
Description: Generate prescription slip PDF
Response: PDF file
Status: 200 OK

GET    /api/pdf/dispense-slip/:id
Description: Generate GOC-compliant dispense slip PDF
Response: PDF file
Status: 200 OK

================================================================================
5. DATABASE SCHEMA OVERVIEW
================================================================================

DATABASE: PostgreSQL 14+
ORM: Drizzle ORM 0.44.7
PLATFORM: Neon Serverless PostgreSQL

TOTAL TABLES: 40+

TABLE CATEGORIES:
1. Core System (users, sessions, companies)
2. Orders & Patients (orders, patients, order_timeline)
3. Point of Sale (products, invoices, invoice_line_items, prescriptions)
4. Suppliers (suppliers, purchase_orders, po_line_items)
5. ECP Features (eye_examinations, test_rooms, test_room_bookings)
6. Lab Features (equipment, dicom_readings)
7. Returns & Quality (returns, non_adapts, quality_issues)
8. Analytics (analytics_events, audit_logs)
9. Email System (email_tracking, email_events, scheduled_emails)
10. AI System (ai_conversations, ai_messages, ai_knowledge_base, ai_learning_data)
11. Notifications (notifications)
12. Subscriptions (subscription_plans, stripe_payment_intents)

KEY FEATURES:
✅ UUID primary keys (gen_random_uuid())
✅ JSONB for flexible data (prescription, specifications, metadata)
✅ Enum types for status fields (type safety)
✅ Timestamps (created_at, updated_at)
✅ Foreign key constraints (referential integrity)
✅ Indexes for performance (company_id, status, dates)
✅ Cascade deletes where appropriate
✅ Change history tracking (JSONB arrays)

DATABASE SIZE:
- Development: ~100MB (sample data)
- Production estimate: 10GB - 100GB (depending on usage)

BACKUP & RECOVERY:
- Neon automatic backups (point-in-time recovery)
- Daily snapshots recommended
- Retention: 30 days

================================================================================
6. KEY DATABASE TABLES
================================================================================

6.1 USERS TABLE
────────────────────────────────────────────────────────────────────────────
Table: users
Purpose: User accounts and authentication

Columns:
- id (UUID, PK)
- email (VARCHAR, UNIQUE)
- password_hash (TEXT) - bcrypt hashed
- first_name (VARCHAR)
- last_name (VARCHAR)
- organization (VARCHAR)
- company_id (UUID, FK → companies.id)
- account_status (ENUM: pending, active, suspended)
- status_reason (TEXT)
- last_status_change (TIMESTAMP)
- created_at (TIMESTAMP)
- updated_at (TIMESTAMP)

Related Tables:
- user_roles (many-to-many with roles)
- sessions (one-to-many)

6.2 COMPANIES TABLE
────────────────────────────────────────────────────────────────────────────
Table: companies
Purpose: Multi-tenant organizations

Columns:
- id (UUID, PK)
- name (TEXT)
- type (ENUM: ecp, lab, supplier, hybrid)
- status (ENUM: pending_approval, active, suspended, deactivated)
- email, phone, website (VARCHAR)
- address (JSONB)
- subscription_plan (ENUM: free_ecp, full)
- stripe_customer_id (VARCHAR)
- stripe_subscription_id (VARCHAR)
- stripe_subscription_status (VARCHAR)
- stripe_current_period_end (TIMESTAMP)
- branding_settings (JSONB)
- settings (JSONB)
- ai_enabled (BOOLEAN)
- ai_learning_progress (INTEGER)
- shopify_enabled (BOOLEAN)
- shopify_shop_url (VARCHAR)
- created_at, updated_at (TIMESTAMP)

Indexes:
- idx_companies_status
- idx_companies_type
- idx_companies_stripe_customer
- idx_companies_stripe_subscription

6.3 ORDERS TABLE
────────────────────────────────────────────────────────────────────────────
Table: orders
Purpose: Lens orders

Columns:
- id (UUID, PK)
- company_id (UUID, FK → companies.id)
- patient_id (UUID, FK → patients.id)
- order_number (VARCHAR, auto-generated)
- customer_reference (VARCHAR)
- status (ENUM: pending, in_production, quality_check, shipped, completed, on_hold, cancelled)
- prescription (JSONB) - { od: {sph, cyl, axis}, os: {...}, add, pd }
- lens_specifications (JSONB) - { type, material, coatings }
- frame_info (JSONB) - { manufacturer, model, size }
- oma_data (JSONB) - parsed OMA file
- notes (TEXT)
- created_by (UUID, FK → users.id)
- created_at, updated_at (TIMESTAMP)

Indexes:
- idx_orders_company
- idx_orders_patient
- idx_orders_status
- idx_orders_created_at

Related Tables:
- order_timeline (status history)
- returns (return requests)
- non_adapts (non-adaptation cases)

6.4 PATIENTS TABLE
────────────────────────────────────────────────────────────────────────────
Table: patients
Purpose: Patient records

Columns:
- id (UUID, PK)
- company_id (UUID, FK → companies.id)
- customer_number (VARCHAR, auto-generated: CUST-XXXXXX)
- first_name, last_name (VARCHAR)
- date_of_birth (DATE)
- email (VARCHAR, unique within company)
- phone (VARCHAR)
- address, city, state, zip_code, country (VARCHAR)
- created_at, updated_at (TIMESTAMP)

Indexes:
- idx_patients_company
- idx_patients_customer_number
- idx_patients_email

Sequences:
- patient_customer_number_seq (starts at 1)

6.5 EYE_EXAMINATIONS TABLE
────────────────────────────────────────────────────────────────────────────
Table: eye_examinations
Purpose: Eye examination records

Columns:
- id (UUID, PK)
- company_id (UUID, FK → companies.id)
- patient_id (UUID, FK → patients.id)
- practitioner_id (UUID, FK → users.id)
- examination_date (TIMESTAMP)
- status (ENUM: in_progress, finalized)
- examination_data (JSONB) - 10 tabs of examination info
- diagnosis (TEXT)
- management_plan (TEXT)
- follow_up_date (DATE)
- finalized_at (TIMESTAMP)
- created_at, updated_at (TIMESTAMP)

JSONB Structure (examination_data):
{
  "patientHistory": {...},
  "visualAcuity": {...},
  "refraction": {...},
  "binocularVision": {...},
  "anteriorEye": {...},
  "iop": {...},
  "posteriorEye": {...},
  "additionalTests": {...},
  "diagnosisManagement": {...},
  "clinicalNotes": {...}
}

6.6 PRODUCTS TABLE (POS)
────────────────────────────────────────────────────────────────────────────
Table: products
Purpose: Inventory management

Columns:
- id (UUID, PK)
- company_id (UUID, FK → companies.id)
- name (VARCHAR)
- sku (VARCHAR, unique within company)
- category (ENUM: frame, contact_lens, solution, service)
- price (DECIMAL)
- cost (DECIMAL)
- stock_quantity (INTEGER)
- low_stock_threshold (INTEGER)
- description (TEXT)
- barcode (VARCHAR)
- supplier_id (UUID, FK → suppliers.id)
- metadata (JSONB)
- created_at, updated_at (TIMESTAMP)

6.7 INVOICES TABLE
────────────────────────────────────────────────────────────────────────────
Table: invoices
Purpose: Sales transactions

Columns:
- id (UUID, PK)
- company_id (UUID, FK → companies.id)
- patient_id (UUID, FK → patients.id)
- invoice_number (VARCHAR, auto-generated)
- invoice_date (TIMESTAMP)
- due_date (TIMESTAMP)
- status (ENUM: draft, paid, void)
- subtotal (DECIMAL)
- tax (DECIMAL)
- discount (DECIMAL)
- total (DECIMAL)
- amount_paid (DECIMAL)
- payment_method (ENUM: cash, card, mixed)
- notes (TEXT)
- created_by (UUID, FK → users.id)
- created_at, updated_at (TIMESTAMP)

Related Table:
- invoice_line_items (one-to-many)

6.8 SUPPLIERS TABLE
────────────────────────────────────────────────────────────────────────────
Table: suppliers
Purpose: Vendor management

Columns:
- id (UUID, PK)
- company_id (UUID, FK → companies.id)
- name (VARCHAR)
- contact_person (VARCHAR)
- email, phone (VARCHAR)
- address (JSONB)
- account_number (VARCHAR)
- status (VARCHAR: active, inactive)
- payment_terms (VARCHAR)
- notes (TEXT)
- created_at, updated_at (TIMESTAMP)

6.9 PURCHASE_ORDERS TABLE
────────────────────────────────────────────────────────────────────────────
Table: purchase_orders
Purpose: Purchase order tracking

Columns:
- id (UUID, PK)
- company_id (UUID, FK → companies.id)
- supplier_id (UUID, FK → suppliers.id)
- po_number (VARCHAR, auto-generated)
- status (ENUM: draft, sent, acknowledged, in_transit, delivered, cancelled)
- order_date (TIMESTAMP)
- expected_delivery_date (DATE)
- actual_delivery_date (DATE)
- customer_reference (VARCHAR)
- subtotal (DECIMAL)
- tax (DECIMAL)
- total (DECIMAL)
- delivery_notes (TEXT)
- created_by (UUID, FK → users.id)
- created_at, updated_at (TIMESTAMP)

Related Table:
- po_line_items (one-to-many)

6.10 AI_CONVERSATIONS TABLE (Planned)
────────────────────────────────────────────────────────────────────────────
Table: ai_conversations
Purpose: AI assistant chat sessions
Status: ⚠️ Created but not functional

Columns:
- id (UUID, PK)
- company_id (UUID, FK → companies.id)
- user_id (UUID, FK → users.id)
- title (TEXT)
- status (VARCHAR: active, archived)
- created_at, updated_at (TIMESTAMP)

Related Table:
- ai_messages (one-to-many)

NOTE: AI tables exist but are not connected to functional APIs.

================================================================================
7. SERVICES ARCHITECTURE
================================================================================

SERVICE LAYER:
Located in: /server/services/

Total Services: 40+

SERVICE CATEGORIES:
1. Core Services (Auth, Email, PDF, Storage)
2. Business Logic (Order, Patient, Inventory)
3. AI Services (Assistant, Intelligence, Forecasting) - PLANNED
4. Integration Services (Stripe, Shopify, External APIs)
5. Analytics Services (Metrics, Reporting, BI)

KEY SERVICES (FUNCTIONAL):

EmailService.ts
- Purpose: Email delivery via Resend
- Features: Transactional emails, templates, tracking
- Status: ✅ Functional

PDFService.ts / ProfessionalPDFService.ts
- Purpose: PDF document generation
- Features: Invoices, POs, work tickets, reports
- Library: PDFKit
- Status: ✅ Functional

OrderService.ts
- Purpose: Order business logic
- Features: Order creation, validation, status management
- Status: ✅ Functional

WebhookService.ts
- Purpose: Stripe webhook handling
- Features: Subscription events, payment processing
- Status: ✅ Functional

StorageService.ts
- Purpose: File upload and storage
- Features: Local filesystem, S3 support
- Status: ✅ Functional

KEY SERVICES (NON-FUNCTIONAL):

AIAssistantService.ts (700+ lines)
- Purpose: AI chat assistant
- Status: ❌ Written but not connected to routes
- Potential: High (if integrated)

NeuralNetworkService.ts
- Purpose: Progressive learning system
- Status: ❌ Code exists, not functional

ExternalAIService.ts
- Purpose: Multi-provider AI (Ollama, OpenAI, Anthropic)
- Status: ❌ Written but not exposed via API

BusinessIntelligenceService.ts
- Purpose: Advanced analytics and insights
- Status: ⚠️ Partial (basic features only)

DemandForecastingService.ts
- Purpose: Predictive analytics
- Status: ❌ Code written, not integrated

SERVICE DESIGN PATTERN:
- Each service is a TypeScript class
- Dependency injection via constructor
- Database access via Drizzle ORM
- Error handling with try-catch
- Logging for debugging
- Type-safe interfaces

EXAMPLE SERVICE STRUCTURE:
```typescript
export class OrderService {
  private db: Database;
  
  constructor(db: Database) {
    this.db = db;
  }
  
  async createOrder(data: CreateOrderInput): Promise<Order> {
    // Validation
    // Business logic
    // Database operations
    // Return result
  }
  
  async updateOrderStatus(orderId: string, status: OrderStatus): Promise<Order> {
    // Validation
    // Authorization checks
    // Update database
    // Create timeline entry
    // Send notifications
    // Return updated order
  }
}
```

SERVICES INTEGRATION:
- Services called from route handlers
- Middleware injects dependencies (database, session)
- Services return typed results
- Errors bubbled to route handler for HTTP responses

================================================================================
END OF PART 2
================================================================================
Next: PART 3 - Deployment, Configuration & Development Guide
