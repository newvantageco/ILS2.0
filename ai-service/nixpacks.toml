# Nixpacks Configuration for ILS 2.0 AI Service
# Uses lightweight requirements for faster deployment

[phases.setup]
nixPkgs = ["python311", "gcc", "zlib", "glib", "libpq"]

[phases.install]
cmds = ["pip install --upgrade pip", "pip install -r requirements.txt"]

[start]
# Entry point is app:app (from app.py at root)
# Use 0.0.0.0 for IPv4 compatibility - Railway health checks require IPv4
# IPv6 [::] causes health check failures
# Use sh -c to ensure $PORT environment variable is expanded
cmd = "sh -c 'uvicorn app:app --host 0.0.0.0 --port ${PORT:-8080} --workers 1'"

[variables]
PYTHON_ENV = "production"
PYTHONUNBUFFERED = "1"
# Memory optimization for AI/ML workloads on Railway
OMP_NUM_THREADS = "1"
MKL_NUM_THREADS = "1"
NUMEXPR_NUM_THREADS = "1"
OPENBLAS_NUM_THREADS = "1"
# Prevent memory fragmentation
MALLOC_TRIM_THRESHOLD_ = "100000"
# Limit PyTorch memory usage if present
PYTORCH_CUDA_ALLOC_CONF = "max_split_size_mb:128"
